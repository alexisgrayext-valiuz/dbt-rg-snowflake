[0m13:33:43.782631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1041f7a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c37890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c37b10>]}


============================== 13:33:43.785353 | 007f0e61-c08d-4d4b-b97e-752f35d411c0 ==============================
[0m13:33:43.785353 [info ] [MainThread]: Running with dbt=1.10.11
[0m13:33:43.785618 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'use_experimental_parser': 'False', 'quiet': 'False', 'introspect': 'True', 'debug': 'False', 'no_print': 'None', 'invocation_command': 'dbt run --select tag:daily', 'indirect_selection': 'eager', 'printer_width': '80', 'warn_error': 'None', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'use_colors': 'True', 'partial_parse': 'True', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'fail_fast': 'False', 'write_json': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'log_format': 'default', 'empty': 'False', 'cache_selected_only': 'False'}
[0m13:33:43.786267 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/profiles.yml
  
[0m13:33:43.800897 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.055868, "process_in_blocks": "0", "process_kernel_time": 0.09927, "process_mem_max_rss": "102744064", "process_out_blocks": "0", "process_user_time": 0.505683}
[0m13:33:43.801199 [debug] [MainThread]: Command `dbt run` failed at 13:33:43.801156 after 0.06 seconds
[0m13:33:43.801360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b275c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c6d6d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ac99d0>]}
[0m13:33:43.801513 [debug] [MainThread]: Flushing usage events
[0m13:33:44.383328 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:34:32.771400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1036fba10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c2b890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c2bb10>]}


============================== 13:34:32.773434 | 6a69b692-4389-4d50-807b-ee92c9882b25 ==============================
[0m13:34:32.773434 [info ] [MainThread]: Running with dbt=1.10.11
[0m13:34:32.773728 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'debug': 'False', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'version_check': 'True', 'quiet': 'False', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'warn_error': 'None', 'fail_fast': 'False', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'use_colors': 'True', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'printer_width': '80', 'invocation_command': 'dbt run --select tag:daily', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'empty': 'False'}
[0m13:34:33.342255 [error] [MainThread]: Encountered an error:
Runtime Error
  Credentials in profile "dbt_rg_snowflake", target "prod" invalid: 'database' is a required property
[0m13:34:33.344148 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.60739946, "process_in_blocks": "0", "process_kernel_time": 0.14391, "process_mem_max_rss": "189431808", "process_out_blocks": "0", "process_user_time": 0.783268}
[0m13:34:33.344430 [debug] [MainThread]: Command `dbt run` failed at 13:34:33.344392 after 0.61 seconds
[0m13:34:33.344570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b1503e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b1357f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0f89e0>]}
[0m13:34:33.344725 [debug] [MainThread]: Flushing usage events
[0m13:34:34.057240 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:35:25.003448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f9fa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074cb890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074cbb10>]}


============================== 13:35:25.005402 | c4c4da5a-0c24-4c61-b506-a189a9d07e12 ==============================
[0m13:35:25.005402 [info ] [MainThread]: Running with dbt=1.10.11
[0m13:35:25.005669 [debug] [MainThread]: running dbt with arguments {'version_check': 'True', 'cache_selected_only': 'False', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'debug': 'False', 'log_cache_events': 'False', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'introspect': 'True', 'quiet': 'False', 'warn_error': 'None', 'partial_parse': 'True', 'invocation_command': 'dbt run --select tag:daily', 'write_json': 'True', 'target_path': 'None', 'fail_fast': 'False', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'printer_width': '80', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_experimental_parser': 'False', 'no_print': 'None', 'empty': 'False', 'static_parser': 'True', 'use_colors': 'True', 'indirect_selection': 'eager'}
[0m13:35:25.448928 [error] [MainThread]: Encountered an error:
Runtime Error
  Credentials in profile "dbt_rg_snowflake", target "prod" invalid: 'schema' is a required property
[0m13:35:25.451325 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.48734474, "process_in_blocks": "0", "process_kernel_time": 0.150899, "process_mem_max_rss": "189792256", "process_out_blocks": "0", "process_user_time": 0.831447}
[0m13:35:25.451623 [debug] [MainThread]: Command `dbt run` failed at 13:35:25.451584 after 0.49 seconds
[0m13:35:25.451767 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9f03e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9e17f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d98c9e0>]}
[0m13:35:25.451919 [debug] [MainThread]: Flushing usage events
[0m13:35:26.116458 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:36:23.483370 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1043ffa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f37890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f37b10>]}


============================== 13:36:23.485970 | a6ad41fb-dbac-4d74-84f4-7092dcd88ad7 ==============================
[0m13:36:23.485970 [info ] [MainThread]: Running with dbt=1.10.11
[0m13:36:23.486243 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'no_print': 'None', 'target_path': 'None', 'printer_width': '80', 'empty': 'False', 'partial_parse': 'True', 'static_parser': 'True', 'write_json': 'True', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'log_cache_events': 'False', 'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'version_check': 'True', 'debug': 'False', 'invocation_command': 'dbt run --select tag:daily', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_experimental_parser': 'False', 'quiet': 'False', 'warn_error': 'None', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'introspect': 'True', 'use_colors': 'True'}
[0m13:36:24.025551 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m13:36:24.025818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'a6ad41fb-dbac-4d74-84f4-7092dcd88ad7', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11621bbb0>]}
[0m13:36:24.026038 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `data-paths` config has been renamed to `seed-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m13:36:24.026176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'a6ad41fb-dbac-4d74-84f4-7092dcd88ad7', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1163a07c0>]}
[0m13:36:24.082767 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a6ad41fb-dbac-4d74-84f4-7092dcd88ad7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x116348550>]}
[0m13:36:24.105142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a6ad41fb-dbac-4d74-84f4-7092dcd88ad7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105cb58b0>]}
[0m13:36:24.105627 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m13:36:24.166280 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found 1 package(s) specified in packages.yml, but only 0 package(s) installed in dbt_packages. Run "dbt deps" to install package dependencies.
[0m13:36:24.166700 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
- ConfigDataPathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m13:36:24.169049 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.72056144, "process_in_blocks": "0", "process_kernel_time": 0.182625, "process_mem_max_rss": "194625536", "process_out_blocks": "0", "process_user_time": 0.869114}
[0m13:36:24.169420 [debug] [MainThread]: Command `dbt run` failed at 13:36:24.169382 after 0.72 seconds
[0m13:36:24.169600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f0fe70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1201925f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1163136c0>]}
[0m13:36:24.169758 [debug] [MainThread]: Flushing usage events
[0m13:36:24.711302 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:36:55.874710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103567a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10552b890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10552bb10>]}


============================== 13:36:55.876582 | 1267fb56-62fa-4e02-b8ee-5adba90a10b7 ==============================
[0m13:36:55.876582 [info ] [MainThread]: Running with dbt=1.10.11
[0m13:36:55.876847 [debug] [MainThread]: running dbt with arguments {'invocation_command': 'dbt deps', 'empty': 'None', 'use_experimental_parser': 'False', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'write_json': 'True', 'fail_fast': 'False', 'version_check': 'True', 'static_parser': 'True', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'quiet': 'False', 'printer_width': '80', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'cache_selected_only': 'False', 'indirect_selection': 'eager', 'partial_parse': 'True', 'target_path': 'None', 'debug': 'False', 'introspect': 'True', 'warn_error': 'None', 'use_colors': 'True'}
[0m13:36:55.882110 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m13:36:55.882283 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '1267fb56-62fa-4e02-b8ee-5adba90a10b7', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10560cc30>]}
[0m13:36:55.882575 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `data-paths` config has been renamed to `seed-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m13:36:55.882713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '1267fb56-62fa-4e02-b8ee-5adba90a10b7', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053ca9c0>]}
[0m13:36:55.932981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1267fb56-62fa-4e02-b8ee-5adba90a10b7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053c2e50>]}
[0m13:36:55.943771 [debug] [MainThread]: Set downloads directory='/var/folders/_4/72gk1pjj4mqc_437tmw2vwkm0000gp/T/dbt-downloads-ruy_a8yx'
[0m13:36:55.943987 [debug] [MainThread]: Making package index registry request: GET https://hub.getdbt.com/api/v1/index.json
[0m13:36:56.248051 [debug] [MainThread]: Response from registry index: GET https://hub.getdbt.com/api/v1/index.json 200
[0m13:36:56.252296 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json
[0m13:36:56.403798 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json 200
[0m13:36:56.407397 [error] [MainThread]: Encountered an error:
Could not find a matching compatible version for package dbt-labs/dbt_utils
  Requested range: =0.7.1, =0.7.1
  Compatible versions: ['0.0.1', '0.1.0', '0.1.1', '0.1.2', '0.1.3', '0.1.4', '0.1.5', '0.1.6', '0.1.7', '0.1.8', '0.1.9', '0.1.10', '0.1.11', '0.1.12', '0.1.13', '0.1.14', '0.1.15', '0.1.16', '0.1.17', '0.1.18', '0.1.19', '0.1.20', '0.1.21', '0.1.22', '0.1.23', '0.1.24', '0.1.25', '0.2.0', '0.2.1', '0.2.2', '0.2.3', '0.2.4', '0.2.5', '0.3.0', '0.4.0', '0.4.1', '0.5.0', '0.8.0', '0.8.1', '0.8.2', '0.8.3', '0.8.4', '0.8.5', '0.8.6', '0.9.0', '0.9.1', '0.9.2', '0.9.5', '0.9.6', '1.0.0', '1.1.0', '1.1.1', '1.2.0', '1.3.0']

  Not shown: package versions incompatible with installed version of dbt-core
  To include them, run 'dbt --no-version-check deps'
[0m13:36:56.410277 [error] [MainThread]: Traceback (most recent call last):
  File "/Users/alexis.gray.ext/Projects/venv/lib/python3.13/site-packages/dbt/cli/requires.py", line 178, in wrapper
    result, success = func(*args, **kwargs)
                      ~~~~^^^^^^^^^^^^^^^^^
  File "/Users/alexis.gray.ext/Projects/venv/lib/python3.13/site-packages/dbt/cli/requires.py", line 128, in wrapper
    return func(*args, **kwargs)
  File "/Users/alexis.gray.ext/Projects/venv/lib/python3.13/site-packages/dbt/cli/requires.py", line 254, in wrapper
    return func(*args, **kwargs)
  File "/Users/alexis.gray.ext/Projects/venv/lib/python3.13/site-packages/dbt/cli/requires.py", line 303, in wrapper
    return func(*args, **kwargs)
  File "/Users/alexis.gray.ext/Projects/venv/lib/python3.13/site-packages/dbt/cli/main.py", line 461, in deps
    results = task.run()
  File "/Users/alexis.gray.ext/Projects/venv/lib/python3.13/site-packages/dbt/task/deps.py", line 215, in run
    self.lock()
    ~~~~~~~~~^^
  File "/Users/alexis.gray.ext/Projects/venv/lib/python3.13/site-packages/dbt/task/deps.py", line 187, in lock
    resolved_deps = resolve_packages(packages, self.project, self.cli_vars)
  File "/Users/alexis.gray.ext/Projects/venv/lib/python3.13/site-packages/dbt/deps/resolver.py", line 131, in resolve_packages
    target = final[package].resolved().fetch_metadata(project, renderer)
             ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/Users/alexis.gray.ext/Projects/venv/lib/python3.13/site-packages/dbt/deps/registry.py", line 124, in resolved
    raise PackageVersionNotFoundError(
        self.package, range_, installable, should_version_check
    )
dbt.exceptions.PackageVersionNotFoundError: Could not find a matching compatible version for package dbt-labs/dbt_utils
  Requested range: =0.7.1, =0.7.1
  Compatible versions: ['0.0.1', '0.1.0', '0.1.1', '0.1.2', '0.1.3', '0.1.4', '0.1.5', '0.1.6', '0.1.7', '0.1.8', '0.1.9', '0.1.10', '0.1.11', '0.1.12', '0.1.13', '0.1.14', '0.1.15', '0.1.16', '0.1.17', '0.1.18', '0.1.19', '0.1.20', '0.1.21', '0.1.22', '0.1.23', '0.1.24', '0.1.25', '0.2.0', '0.2.1', '0.2.2', '0.2.3', '0.2.4', '0.2.5', '0.3.0', '0.4.0', '0.4.1', '0.5.0', '0.8.0', '0.8.1', '0.8.2', '0.8.3', '0.8.4', '0.8.5', '0.8.6', '0.9.0', '0.9.1', '0.9.2', '0.9.5', '0.9.6', '1.0.0', '1.1.0', '1.1.1', '1.2.0', '1.3.0']

  Not shown: package versions incompatible with installed version of dbt-core
  To include them, run 'dbt --no-version-check deps'

[0m13:36:56.410771 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
- ConfigDataPathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m13:36:56.412435 [debug] [MainThread]: Resource report: {"command_name": "deps", "command_success": false, "command_wall_clock_time": 0.5717786, "process_in_blocks": "0", "process_kernel_time": 0.081104, "process_mem_max_rss": "114311168", "process_out_blocks": "0", "process_user_time": 0.61597}
[0m13:36:56.412722 [debug] [MainThread]: Command `dbt deps` failed at 13:36:56.412667 after 0.57 seconds
[0m13:36:56.412942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10558b890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10558bc50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10550fe70>]}
[0m13:36:56.413153 [debug] [MainThread]: Flushing usage events
[0m13:36:57.107743 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:37:32.948469 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052ffa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10762b890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10762bb10>]}


============================== 13:37:32.950333 | b7e47c6c-18da-40f0-9db1-5a4223ae0ba9 ==============================
[0m13:37:32.950333 [info ] [MainThread]: Running with dbt=1.10.11
[0m13:37:32.950599 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'introspect': 'True', 'target_path': 'None', 'version_check': 'True', 'log_format': 'default', 'log_cache_events': 'False', 'empty': 'None', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'use_experimental_parser': 'False', 'fail_fast': 'False', 'static_parser': 'True', 'partial_parse': 'True', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'invocation_command': 'dbt deps', 'use_colors': 'True', 'indirect_selection': 'eager', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'cache_selected_only': 'False', 'debug': 'False', 'printer_width': '80'}
[0m13:37:32.956120 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m13:37:32.956297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'b7e47c6c-18da-40f0-9db1-5a4223ae0ba9', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107708c30>]}
[0m13:37:32.956557 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `data-paths` config has been renamed to `seed-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m13:37:32.956788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'b7e47c6c-18da-40f0-9db1-5a4223ae0ba9', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074ca9c0>]}
[0m13:37:33.000578 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b7e47c6c-18da-40f0-9db1-5a4223ae0ba9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074c2e50>]}
[0m13:37:33.005962 [debug] [MainThread]: Set downloads directory='/var/folders/_4/72gk1pjj4mqc_437tmw2vwkm0000gp/T/dbt-downloads-b_eiwekm'
[0m13:37:33.006167 [debug] [MainThread]: Making package index registry request: GET https://hub.getdbt.com/api/v1/index.json
[0m13:37:33.159361 [debug] [MainThread]: Response from registry index: GET https://hub.getdbt.com/api/v1/index.json 200
[0m13:37:33.161051 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json
[0m13:37:33.335923 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json 200
[0m13:37:33.355145 [info ] [MainThread]: Updating lock file in file path: /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/package-lock.yml
[0m13:37:33.357513 [debug] [MainThread]: Set downloads directory='/var/folders/_4/72gk1pjj4mqc_437tmw2vwkm0000gp/T/dbt-downloads-yiouiyvo'
[0m13:37:33.360349 [info ] [MainThread]: Installing dbt-labs/dbt_utils
[0m13:37:33.950086 [info ] [MainThread]: Installed from version 1.3.0
[0m13:37:33.950362 [info ] [MainThread]: Up to date!
[0m13:37:33.950614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'package', 'label': 'b7e47c6c-18da-40f0-9db1-5a4223ae0ba9', 'property_': 'install', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b6990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10768b890>]}
[0m13:37:33.951485 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
- ConfigDataPathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m13:37:33.952924 [debug] [MainThread]: Resource report: {"command_name": "deps", "command_success": true, "command_wall_clock_time": 1.0387794, "process_in_blocks": "0", "process_kernel_time": 0.136465, "process_mem_max_rss": "114982912", "process_out_blocks": "0", "process_user_time": 0.636928}
[0m13:37:33.953141 [debug] [MainThread]: Command `dbt deps` succeeded at 13:37:33.953096 after 1.04 seconds
[0m13:37:33.953302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10760fe70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065b2c30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1072df590>]}
[0m13:37:33.953450 [debug] [MainThread]: Flushing usage events
[0m13:37:34.554381 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:38:14.806745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107a97a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c2b890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c2bb10>]}


============================== 13:38:14.808816 | ef2016ab-1067-4138-869d-496f4baf002d ==============================
[0m13:38:14.808816 [info ] [MainThread]: Running with dbt=1.10.11
[0m13:38:14.809092 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'introspect': 'True', 'cache_selected_only': 'False', 'fail_fast': 'False', 'partial_parse': 'True', 'invocation_command': 'dbt deps', 'no_print': 'None', 'empty': 'None', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'warn_error': 'None', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_colors': 'True', 'static_parser': 'True', 'write_json': 'True', 'version_check': 'True', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'printer_width': '80', 'debug': 'False', 'target_path': 'None', 'log_cache_events': 'False', 'quiet': 'False'}
[0m13:38:14.858276 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ef2016ab-1067-4138-869d-496f4baf002d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b435c0>]}
[0m13:38:14.877603 [debug] [MainThread]: Set downloads directory='/var/folders/_4/72gk1pjj4mqc_437tmw2vwkm0000gp/T/dbt-downloads-4xkzt3x2'
[0m13:38:14.877805 [debug] [MainThread]: Making package index registry request: GET https://hub.getdbt.com/api/v1/index.json
[0m13:38:15.108928 [debug] [MainThread]: Response from registry index: GET https://hub.getdbt.com/api/v1/index.json 200
[0m13:38:15.111638 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json
[0m13:38:15.297038 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json 200
[0m13:38:15.300191 [info ] [MainThread]: Installing dbt-labs/dbt_utils
[0m13:38:15.962998 [info ] [MainThread]: Installed from version 1.3.0
[0m13:38:15.963376 [info ] [MainThread]: Up to date!
[0m13:38:15.963793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'package', 'label': 'ef2016ab-1067-4138-869d-496f4baf002d', 'property_': 'install', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1119ca690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1119cb020>]}
[0m13:38:15.965547 [debug] [MainThread]: Resource report: {"command_name": "deps", "command_success": true, "command_wall_clock_time": 1.1932069, "process_in_blocks": "0", "process_kernel_time": 0.161029, "process_mem_max_rss": "114835456", "process_out_blocks": "0", "process_user_time": 0.637069}
[0m13:38:15.965816 [debug] [MainThread]: Command `dbt deps` succeeded at 13:38:15.965756 after 1.19 seconds
[0m13:38:15.965989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e35650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1119b6990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c8bb60>]}
[0m13:38:15.966145 [debug] [MainThread]: Flushing usage events
[0m13:38:16.657753 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:38:23.343635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103417a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10493f890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10493fb10>]}


============================== 13:38:23.345487 | 0ed76cce-b96b-40c6-832e-7ff25237b046 ==============================
[0m13:38:23.345487 [info ] [MainThread]: Running with dbt=1.10.11
[0m13:38:23.345757 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'partial_parse': 'True', 'debug': 'False', 'use_colors': 'True', 'version_check': 'True', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'write_json': 'True', 'invocation_command': 'dbt run --select tag:daily', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'introspect': 'True', 'warn_error': 'None', 'cache_selected_only': 'False', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'printer_width': '80', 'no_print': 'None', 'target_path': 'None', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'fail_fast': 'False', 'log_cache_events': 'False', 'quiet': 'False', 'static_parser': 'True', 'log_format': 'default', 'indirect_selection': 'eager'}
[0m13:38:23.729384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0ed76cce-b96b-40c6-832e-7ff25237b046', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103c4f5c0>]}
[0m13:38:23.752879 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0ed76cce-b96b-40c6-832e-7ff25237b046', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae086b0>]}
[0m13:38:23.753328 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m13:38:23.805530 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m13:38:23.805928 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m13:38:23.806091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '0ed76cce-b96b-40c6-832e-7ff25237b046', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10adb1350>]}
[0m13:38:24.177305 [error] [MainThread]: Encountered an error:
Internal Error
  Got an unexpected project version=1, expected 2
[0m13:38:24.179284 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.8694899, "process_in_blocks": "0", "process_kernel_time": 0.169469, "process_mem_max_rss": "197853184", "process_out_blocks": "0", "process_user_time": 1.221369}
[0m13:38:24.179634 [debug] [MainThread]: Command `dbt run` failed at 13:38:24.179584 after 0.87 seconds
[0m13:38:24.179802 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad773e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102e4af30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104917e70>]}
[0m13:38:24.179953 [debug] [MainThread]: Flushing usage events
[0m13:38:25.134705 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:38:56.355986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074bfa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089ef890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089efb10>]}


============================== 13:38:56.358059 | cc770995-edf0-4fed-89bd-dfdf8577173f ==============================
[0m13:38:56.358059 [info ] [MainThread]: Running with dbt=1.10.11
[0m13:38:56.358330 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'printer_width': '80', 'partial_parse': 'True', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'introspect': 'True', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'log_format': 'default', 'fail_fast': 'False', 'no_print': 'None', 'warn_error': 'None', 'write_json': 'True', 'debug': 'False', 'quiet': 'False', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'version_check': 'True', 'target_path': 'None', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'cache_selected_only': 'False', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:daily'}
[0m13:38:56.727396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cc770995-edf0-4fed-89bd-dfdf8577173f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cfb5c0>]}
[0m13:38:56.749934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cc770995-edf0-4fed-89bd-dfdf8577173f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eebc6b0>]}
[0m13:38:56.750308 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m13:38:56.803056 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m13:38:56.803477 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m13:38:56.803640 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'cc770995-edf0-4fed-89bd-dfdf8577173f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee61350>]}
[0m13:38:57.257039 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'dim_customers' in the 'models' section of file 'models/marts/core/core.yml'
[0m13:38:57.258310 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'dim_parts' in the 'models' section of file 'models/marts/core/core.yml'
[0m13:38:57.259164 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'dim_suppliers' in the 'models' section of file 'models/marts/core/core.yml'
[0m13:38:57.261836 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'fct_order_items' in the 'models' section of file 'models/marts/core/core.yml'
[0m13:38:57.262818 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'fct_orders' in the 'models' section of file 'models/marts/core/core.yml'
[0m13:38:57.298223 [warn ] [MainThread]: [[33mWARNING[0m][MissingArgumentsPropertyInGenericTestDeprecation]: Deprecated
functionality
Found top-level arguments to test `accepted_values`. Arguments to generic tests
should be nested under the `arguments` property.`
[0m13:38:57.298489 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'cc770995-edf0-4fed-89bd-dfdf8577173f', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2e9b80>]}
[0m13:38:57.325353 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'agg_ship_modes_hardcoded_pivot' in the 'models' section of file 'models/marts/aggregates/aggregates.yml'
[0m13:38:57.325759 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'agg_ship_modes_dynamic_pivot' in the 'models' section of file 'models/marts/aggregates/aggregates.yml'
[0m13:38:57.326749 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'order_items' in the 'models' section of file 'models/marts/intermediate/intermediate.yml'
[0m13:38:57.328201 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'part_suppliers' in the 'models' section of file 'models/marts/intermediate/intermediate.yml'
[0m13:38:57.331518 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.unique_dim_customers_customer_key.ad8156656e' (models/marts/core/core.yml) depends on a node named 'dim_customers' in package '' which was not found
[0m13:38:57.331697 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.not_null_dim_customers_customer_key.4bebfb3411' (models/marts/core/core.yml) depends on a node named 'dim_customers' in package '' which was not found
[0m13:38:57.331849 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.accepted_values_dim_customers_region__AFRICA__MIDDLE_EAST__ASIA__EUROPE__AMERICA.dad4601b69' (models/marts/core/core.yml) depends on a node named 'dim_customers' in package '' which was not found
[0m13:38:57.331980 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.unique_dim_parts_part_key.712df18d58' (models/marts/core/core.yml) depends on a node named 'dim_parts' in package '' which was not found
[0m13:38:57.332104 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.not_null_dim_parts_part_key.4358f880d9' (models/marts/core/core.yml) depends on a node named 'dim_parts' in package '' which was not found
[0m13:38:57.332227 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.unique_dim_suppliers_supplier_key.58fc3e4770' (models/marts/core/core.yml) depends on a node named 'dim_suppliers' in package '' which was not found
[0m13:38:57.332349 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.not_null_dim_suppliers_supplier_key.4315350956' (models/marts/core/core.yml) depends on a node named 'dim_suppliers' in package '' which was not found
[0m13:38:57.332471 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.unique_fct_order_items_order_item_key.4d6426a255' (models/marts/core/core.yml) depends on a node named 'fct_order_items' in package '' which was not found
[0m13:38:57.332589 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.not_null_fct_order_items_order_item_key.47516a6371' (models/marts/core/core.yml) depends on a node named 'fct_order_items' in package '' which was not found
[0m13:38:57.332711 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.unique_fct_orders_order_key.f5e7a90273' (models/marts/core/core.yml) depends on a node named 'fct_orders' in package '' which was not found
[0m13:38:57.332828 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.not_null_fct_orders_order_key.6a6f83ab15' (models/marts/core/core.yml) depends on a node named 'fct_orders' in package '' which was not found
[0m13:38:57.332949 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.relationships_fct_orders_customer_key__customer_key__ref_dim_customers_.018eb0a60b' (models/marts/core/core.yml) depends on a node named 'dim_customers' in package '' which was not found
[0m13:38:57.333076 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.relationships_fct_orders_customer_key__customer_key__ref_dim_customers_.018eb0a60b' (models/marts/core/core.yml) depends on a node named 'fct_orders' in package '' which was not found
[0m13:38:57.333194 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.unique_order_items_order_item_key.43a40b2837' (models/marts/intermediate/intermediate.yml) depends on a node named 'order_items' in package '' which was not found
[0m13:38:57.333311 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.not_null_order_items_order_item_key.44b9fa7311' (models/marts/intermediate/intermediate.yml) depends on a node named 'order_items' in package '' which was not found
[0m13:38:57.333428 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.unique_part_suppliers_part_supplier_key.909477afa8' (models/marts/intermediate/intermediate.yml) depends on a node named 'part_suppliers' in package '' which was not found
[0m13:38:57.333547 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.dbt_rg_snowflake.not_null_part_suppliers_part_supplier_key.b8b2022ed3' (models/marts/intermediate/intermediate.yml) depends on a node named 'part_suppliers' in package '' which was not found
[0m13:38:57.333703 [error] [MainThread]: Encountered an error:
Compilation Error
  Exposure 'exposure.dbt_rg_snowflake.yearly_part_rollup' (models/marts/aggregates/exposures.yml) depends on a node named 'agg_ship_modes_dynamic_pivot' which was not found
[0m13:38:57.333909 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- MissingArgumentsPropertyInGenericTestDeprecation: 2 occurrences
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m13:38:57.335714 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 1.0144603, "process_in_blocks": "0", "process_kernel_time": 0.168954, "process_mem_max_rss": "206340096", "process_out_blocks": "0", "process_user_time": 1.38978}
[0m13:38:57.335957 [debug] [MainThread]: Command `dbt run` failed at 13:38:57.335922 after 1.01 seconds
[0m13:38:57.336099 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089c7e70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f6a1ef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3382c0>]}
[0m13:38:57.336230 [debug] [MainThread]: Flushing usage events
[0m13:38:57.875337 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:52:35.408723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105477a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10699f890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10699fb10>]}


============================== 13:52:35.411355 | 5eee39eb-3755-4279-906b-2107cee5160f ==============================
[0m13:52:35.411355 [info ] [MainThread]: Running with dbt=1.10.11
[0m13:52:35.411657 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'static_parser': 'True', 'no_print': 'None', 'version_check': 'True', 'introspect': 'True', 'quiet': 'False', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'warn_error': 'None', 'invocation_command': 'dbt run --select tag:daily', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'log_format': 'default', 'debug': 'False', 'printer_width': '80', 'log_cache_events': 'False', 'target_path': 'None', 'write_json': 'True', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m13:52:36.034542 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5eee39eb-3755-4279-906b-2107cee5160f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105caf5c0>]}
[0m13:52:36.056546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5eee39eb-3755-4279-906b-2107cee5160f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce6c6b0>]}
[0m13:52:36.057041 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m13:52:36.113174 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m13:52:36.113578 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m13:52:36.113730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '5eee39eb-3755-4279-906b-2107cee5160f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce11350>]}
[0m13:52:36.626144 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 3 unused configuration paths:
- models.dbt_rg_snowflake.staging
- models.dbt_rg_snowflake.marts.core
- seeds
[0m13:52:36.628168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5eee39eb-3755-4279-906b-2107cee5160f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d244500>]}
[0m13:52:36.653295 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m13:52:36.656238 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m13:52:36.667345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5eee39eb-3755-4279-906b-2107cee5160f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d57a430>]}
[0m13:52:36.667542 [info ] [MainThread]: Found 1 model, 596 macros
[0m13:52:36.667674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5eee39eb-3755-4279-906b-2107cee5160f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2f7ee0>]}
[0m13:52:36.668265 [info ] [MainThread]: 
[0m13:52:36.668396 [info ] [MainThread]: Concurrency: 4 threads (target='prod')
[0m13:52:36.668505 [info ] [MainThread]: 
[0m13:52:36.668703 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m13:52:36.669048 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_RG_DLK'
[0m13:52:36.706325 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_RG_DLK"
[0m13:52:36.706500 [debug] [ThreadPool]: On list_FD_IO_RG_DLK: show terse schemas in database FD_IO_RG_DLK
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_RG_DLK"} */
[0m13:52:36.706609 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:53:02.249375 [debug] [ThreadPool]: Snowflake adapter: Snowflake query id: 01bee9a9-0107-2480-0004-a2560002b13a
[0m13:53:02.250127 [debug] [ThreadPool]: Snowflake adapter: Snowflake error: 002043 (02000): SQL compilation error:
Object does not exist, or operation cannot be performed.
[0m13:53:02.250747 [debug] [ThreadPool]: Snowflake adapter: Error running SQL: macro list_schemas
[0m13:53:02.251106 [debug] [ThreadPool]: Snowflake adapter: Rolling back transaction.
[0m13:53:02.252467 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:53:02.252824 [debug] [MainThread]: Connection 'list_FD_IO_RG_DLK' was left open.
[0m13:53:02.253084 [debug] [MainThread]: On list_FD_IO_RG_DLK: Close
[0m13:53:04.734939 [info ] [MainThread]: 
[0m13:53:04.736462 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 28.07 seconds (28.07s).
[0m13:53:04.737493 [error] [MainThread]: Encountered an error:
Runtime Error
  Database error while listing schemas in database "FD_IO_RG_DLK"
  Database Error
    002043 (02000): SQL compilation error:
    Object does not exist, or operation cannot be performed.
[0m13:53:04.747794 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 29.373955, "process_in_blocks": "0", "process_kernel_time": 0.382388, "process_mem_max_rss": "235061248", "process_out_blocks": "0", "process_user_time": 1.779278}
[0m13:53:04.748523 [debug] [MainThread]: Command `dbt run` failed at 13:53:04.748407 after 29.37 seconds
[0m13:53:04.748961 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106747590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111359700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111359860>]}
[0m13:53:04.749320 [debug] [MainThread]: Flushing usage events
[0m13:53:12.753626 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:11:34.324804 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fffa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b37890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b37b10>]}


============================== 14:11:34.327416 | 689386fe-6cc3-4156-a5fd-e4d41bded222 ==============================
[0m14:11:34.327416 [info ] [MainThread]: Running with dbt=1.10.11
[0m14:11:34.327690 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'empty': 'False', 'quiet': 'False', 'fail_fast': 'False', 'version_check': 'True', 'cache_selected_only': 'False', 'debug': 'False', 'write_json': 'True', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:daily', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'introspect': 'True', 'partial_parse': 'True', 'log_cache_events': 'False', 'printer_width': '80', 'use_colors': 'True', 'log_format': 'default', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'warn_error': 'None', 'no_print': 'None'}
[0m14:11:34.954541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '689386fe-6cc3-4156-a5fd-e4d41bded222', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a435c0>]}
[0m14:11:34.976502 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '689386fe-6cc3-4156-a5fd-e4d41bded222', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1223a46b0>]}
[0m14:11:34.976956 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m14:11:35.034215 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m14:11:35.064692 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m14:11:35.064936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '689386fe-6cc3-4156-a5fd-e4d41bded222', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x122349450>]}
[0m14:11:35.570397 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 3 unused configuration paths:
- models.dbt_rg_snowflake.staging
- models.dbt_rg_snowflake.marts.core
- seeds
[0m14:11:35.572367 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '689386fe-6cc3-4156-a5fd-e4d41bded222', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x122a507d0>]}
[0m14:11:35.596797 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:11:35.598087 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:11:35.607785 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '689386fe-6cc3-4156-a5fd-e4d41bded222', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x122e4b230>]}
[0m14:11:35.608056 [info ] [MainThread]: Found 1 model, 596 macros
[0m14:11:35.608239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '689386fe-6cc3-4156-a5fd-e4d41bded222', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x122ef3ee0>]}
[0m14:11:35.608914 [info ] [MainThread]: 
[0m14:11:35.609056 [info ] [MainThread]: Concurrency: 4 threads (target='prod')
[0m14:11:35.609164 [info ] [MainThread]: 
[0m14:11:35.609361 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m14:11:35.609701 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG'
[0m14:11:35.638877 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG"
[0m14:11:35.639062 [debug] [ThreadPool]: On list_FD_IO_DLK_RG: show terse schemas in database FD_IO_DLK_RG
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG"} */
[0m14:11:35.639173 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:11:38.929808 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.291 seconds
[0m14:11:38.931297 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG, now create_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION)
[0m14:11:38.931679 [debug] [ThreadPool]: Creating schema "database: "FD_IO_DLK_RG"
schema: "DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"
"
[0m14:11:38.935457 [debug] [ThreadPool]: Using snowflake connection "create_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"
[0m14:11:38.935694 [debug] [ThreadPool]: On create_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION: create schema if not exists FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "create_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"} */
[0m14:11:39.078067 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.142 seconds
[0m14:11:39.081295 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION, now list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION)
[0m14:11:39.096596 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"
[0m14:11:39.096966 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION: show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"} */;
[0m14:11:39.559413 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 0.462 seconds
[0m14:11:39.560611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '689386fe-6cc3-4156-a5fd-e4d41bded222', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x125926090>]}
[0m14:11:39.564660 [debug] [Thread-1 (]: Began running node model.dbt_rg_snowflake.test
[0m14:11:39.564980 [info ] [Thread-1 (]: 1 of 1 START sql table model DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test  [RUN]
[0m14:11:39.565227 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m14:11:39.565418 [debug] [Thread-1 (]: Began compiling node model.dbt_rg_snowflake.test
[0m14:11:39.569675 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m14:11:39.570330 [debug] [Thread-1 (]: Began executing node model.dbt_rg_snowflake.test
[0m14:11:39.586984 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_rg_snowflake.test"
[0m14:11:39.593965 [debug] [Thread-1 (]: Using snowflake connection "model.dbt_rg_snowflake.test"
[0m14:11:39.594531 [debug] [Thread-1 (]: On model.dbt_rg_snowflake.test: create or replace transient table FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test
    
    
    
    as (--CREATE OR REPLACE TABLE FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.agg_ticket_rg AS (

WITH first_ticket as (
    SELECT master_customer_id,
           min(purchase_date) as date_first_ticket
    from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg
    group by master_customer_id
)

SELECT a.master_customer_id, 
       
       min(purchase_date) as date_first_purchase,
       max(purchase_date) as date_last_purchase,
       AVG(DATEDIFF(DAY, lag_date_purchase, purchase_date)) as avg_delta_jour,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_web end ) AS amount_including_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then amount_including_taxes_mag end ) AS amount_including_taxes_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_day end ) AS amount_including_taxes_12m, 
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_ticket_web end ) AS nb_ticket_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket_mag end ) AS nb_ticket_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket end ) AS nb_ticket_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_achat_actif end ) AS nb_achat_actif_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  margin_excluding_taxes end ) as margin_excluding_taxes_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_web end ) as margin_excluding_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_mag end ) as margin_excluding_taxes_mag_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_web end ) AS nb_product_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_mag end ) AS nb_product_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte end ) AS nb_product_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_art end ) as nb_art_12m,
       sum(abs(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_retour end )) as nb_retour_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_markdown_including_taxes end ) as customer_markdown_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_discount_including_taxes end ) as customer_discount_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then initial_selling_price end ) as initial_selling_price_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  Total_Discount end )  as Total_Discount_12M,

       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_0_6m, 
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte else 0 end) AS nb_product_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_art else 0 end) as nb_art_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_0_6m,

       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_6_12m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte else 0 end) AS nb_product_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_art else 0 end) as nb_art_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_6_12m,
       
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_12m_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_12_18m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte else 0 end) AS nb_product_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_art else 0 end) as nb_art_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_12_18m,    

       SUM(case when(purchase_date = date_first_ticket) then amount_including_taxes_day else 0 end) AS amount_including_taxes_first_ticket, 
       SUM(case when(purchase_date = date_first_ticket) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_first_ticket,
       SUM(case when(purchase_date = date_first_ticket) then qte else 0 end) AS nb_product_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then nb_art else 0 end) as nb_art_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then initial_selling_price else 0 end) as initial_selling_price_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then Total_Discount else 0 end) as Total_Discount_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then amount_ventes else 0 end) as amount_ventes_first_ticket
      
from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg a
left join first_ticket b
on a.master_customer_id = b.master_customer_id

where purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)
and purchase_date >= b.date_first_ticket
group by a.master_customer_id

--)
    )

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "node_id": "model.dbt_rg_snowflake.test"} */;
[0m14:11:48.168461 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 8.569 seconds
[0m14:11:48.197982 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '689386fe-6cc3-4156-a5fd-e4d41bded222', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x125b86f10>]}
[0m14:11:48.198694 [info ] [Thread-1 (]: 1 of 1 OK created sql table model DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test  [[32mSUCCESS 1[0m in 8.63s]
[0m14:11:48.199125 [debug] [Thread-1 (]: Finished running node model.dbt_rg_snowflake.test
[0m14:11:48.200162 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:11:48.200361 [debug] [MainThread]: Connection 'model.dbt_rg_snowflake.test' was left open.
[0m14:11:48.200551 [debug] [MainThread]: On model.dbt_rg_snowflake.test: Close
[0m14:11:48.375292 [info ] [MainThread]: 
[0m14:11:48.376354 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.77 seconds (12.77s).
[0m14:11:48.377111 [debug] [MainThread]: Command end result
[0m14:11:48.397927 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:11:48.399291 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:11:48.402853 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/run_results.json
[0m14:11:48.403040 [info ] [MainThread]: 
[0m14:11:48.403259 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:11:48.403419 [info ] [MainThread]: 
[0m14:11:48.403591 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m14:11:48.406751 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 14.1139965, "process_in_blocks": "0", "process_kernel_time": 0.293884, "process_mem_max_rss": "233521152", "process_out_blocks": "0", "process_user_time": 1.758551}
[0m14:11:48.406992 [debug] [MainThread]: Command `dbt run` succeeded at 14:11:48.406948 after 14.11 seconds
[0m14:11:48.407182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x125b1f110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x125bf9d00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x122bfd6d0>]}
[0m14:11:48.407367 [debug] [MainThread]: Flushing usage events
[0m14:11:49.017779 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:15:08.011940 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10579ba10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cc3890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cc3b10>]}


============================== 14:15:08.014643 | 6f1d7b63-fe07-494d-9eec-242181c46680 ==============================
[0m14:15:08.014643 [info ] [MainThread]: Running with dbt=1.10.11
[0m14:15:08.014926 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'warn_error': 'None', 'partial_parse': 'True', 'fail_fast': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_colors': 'True', 'use_experimental_parser': 'False', 'printer_width': '80', 'target_path': 'None', 'introspect': 'True', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'indirect_selection': 'eager', 'quiet': 'False', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:daily', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'write_json': 'True', 'cache_selected_only': 'False', 'log_format': 'default', 'version_check': 'True'}
[0m14:15:08.576652 [error] [MainThread]: Encountered an error:
Runtime Error
  at path ['models']: 'dbt_rg_snowflake' is not of type 'object'

Error encountered in /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/dbt_project.yml
[0m14:15:08.579109 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.6025715, "process_in_blocks": "0", "process_kernel_time": 0.17291, "process_mem_max_rss": "190480384", "process_out_blocks": "0", "process_user_time": 0.807909}
[0m14:15:08.579387 [debug] [MainThread]: Command `dbt run` failed at 14:15:08.579350 after 0.60 seconds
[0m14:15:08.579528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2ff5c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3970b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f298c00>]}
[0m14:15:08.579669 [debug] [MainThread]: Flushing usage events
[0m14:15:09.232043 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:17:41.028379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105d47a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10726f890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10726fb10>]}


============================== 14:17:41.031023 | 88166662-91db-421b-933b-a3902068df6c ==============================
[0m14:17:41.031023 [info ] [MainThread]: Running with dbt=1.10.11
[0m14:17:41.031318 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'no_print': 'None', 'write_json': 'True', 'static_parser': 'True', 'quiet': 'False', 'printer_width': '80', 'use_experimental_parser': 'False', 'cache_selected_only': 'False', 'warn_error': 'None', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'fail_fast': 'False', 'debug': 'False', 'partial_parse': 'True', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'invocation_command': 'dbt run --select tag:daily', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'use_colors': 'True', 'indirect_selection': 'eager', 'empty': 'False', 'log_format': 'default'}
[0m14:17:41.609803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '88166662-91db-421b-933b-a3902068df6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10657f5c0>]}
[0m14:17:41.632361 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '88166662-91db-421b-933b-a3902068df6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d6686b0>]}
[0m14:17:41.632898 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m14:17:41.688682 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m14:17:41.719307 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m14:17:41.719557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '88166662-91db-421b-933b-a3902068df6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d611450>]}
[0m14:17:42.216901 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 2 unused configuration paths:
- models.dbt_rg_snowflake.test
- seeds
[0m14:17:42.218926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '88166662-91db-421b-933b-a3902068df6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db187d0>]}
[0m14:17:42.243758 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:17:42.247185 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:17:42.257047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '88166662-91db-421b-933b-a3902068df6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10de17230>]}
[0m14:17:42.257238 [info ] [MainThread]: Found 1 model, 596 macros
[0m14:17:42.257371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '88166662-91db-421b-933b-a3902068df6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10debfee0>]}
[0m14:17:42.257991 [info ] [MainThread]: 
[0m14:17:42.258130 [info ] [MainThread]: Concurrency: 4 threads (target='prod')
[0m14:17:42.258237 [info ] [MainThread]: 
[0m14:17:42.258434 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m14:17:42.258774 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG'
[0m14:17:42.287571 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG"
[0m14:17:42.287761 [debug] [ThreadPool]: On list_FD_IO_DLK_RG: show terse schemas in database FD_IO_DLK_RG
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG"} */
[0m14:17:42.287877 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:17:45.398181 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 3.110 seconds
[0m14:17:45.402436 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG, now list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION)
[0m14:17:45.418002 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"
[0m14:17:45.418419 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION: show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"} */;
[0m14:17:45.734198 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.315 seconds
[0m14:17:45.739067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '88166662-91db-421b-933b-a3902068df6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115225850>]}
[0m14:17:45.745919 [debug] [Thread-1 (]: Began running node model.dbt_rg_snowflake.test
[0m14:17:45.746685 [info ] [Thread-1 (]: 1 of 1 START sql table model DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test  [RUN]
[0m14:17:45.747251 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m14:17:45.747659 [debug] [Thread-1 (]: Began compiling node model.dbt_rg_snowflake.test
[0m14:17:45.755538 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m14:17:45.756749 [debug] [Thread-1 (]: Began executing node model.dbt_rg_snowflake.test
[0m14:17:45.780362 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_rg_snowflake.test"
[0m14:17:45.788547 [debug] [Thread-1 (]: Using snowflake connection "model.dbt_rg_snowflake.test"
[0m14:17:45.789165 [debug] [Thread-1 (]: On model.dbt_rg_snowflake.test: create or replace transient table FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test
    
    
    
    as (--CREATE OR REPLACE TABLE FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.agg_ticket_rg AS (

WITH first_ticket as (
    SELECT master_customer_id,
           min(purchase_date) as date_first_ticket
    from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg
    group by master_customer_id
)

SELECT a.master_customer_id, 
       
       min(purchase_date) as date_first_purchase,
       max(purchase_date) as date_last_purchase,
       AVG(DATEDIFF(DAY, lag_date_purchase, purchase_date)) as avg_delta_jour,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_web end ) AS amount_including_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then amount_including_taxes_mag end ) AS amount_including_taxes_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_day end ) AS amount_including_taxes_12m, 
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_ticket_web end ) AS nb_ticket_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket_mag end ) AS nb_ticket_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket end ) AS nb_ticket_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_achat_actif end ) AS nb_achat_actif_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  margin_excluding_taxes end ) as margin_excluding_taxes_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_web end ) as margin_excluding_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_mag end ) as margin_excluding_taxes_mag_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_web end ) AS nb_product_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_mag end ) AS nb_product_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte end ) AS nb_product_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_art end ) as nb_art_12m,
       sum(abs(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_retour end )) as nb_retour_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_markdown_including_taxes end ) as customer_markdown_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_discount_including_taxes end ) as customer_discount_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then initial_selling_price end ) as initial_selling_price_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  Total_Discount end )  as Total_Discount_12M,

       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_0_6m, 
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte else 0 end) AS nb_product_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_art else 0 end) as nb_art_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_0_6m,

       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_6_12m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte else 0 end) AS nb_product_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_art else 0 end) as nb_art_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_6_12m,
       
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_12m_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_12_18m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte else 0 end) AS nb_product_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_art else 0 end) as nb_art_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_12_18m,    

       SUM(case when(purchase_date = date_first_ticket) then amount_including_taxes_day else 0 end) AS amount_including_taxes_first_ticket, 
       SUM(case when(purchase_date = date_first_ticket) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_first_ticket,
       SUM(case when(purchase_date = date_first_ticket) then qte else 0 end) AS nb_product_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then nb_art else 0 end) as nb_art_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then initial_selling_price else 0 end) as initial_selling_price_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then Total_Discount else 0 end) as Total_Discount_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then amount_ventes else 0 end) as amount_ventes_first_ticket
      
from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg a
left join first_ticket b
on a.master_customer_id = b.master_customer_id

where purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)
and purchase_date >= b.date_first_ticket
group by a.master_customer_id

--)
    )

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "node_id": "model.dbt_rg_snowflake.test"} */;
[0m14:17:54.295619 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 8.505 seconds
[0m14:17:54.324493 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88166662-91db-421b-933b-a3902068df6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115487070>]}
[0m14:17:54.325124 [info ] [Thread-1 (]: 1 of 1 OK created sql table model DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test  [[32mSUCCESS 1[0m in 8.58s]
[0m14:17:54.325532 [debug] [Thread-1 (]: Finished running node model.dbt_rg_snowflake.test
[0m14:17:54.326530 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:17:54.326770 [debug] [MainThread]: Connection 'model.dbt_rg_snowflake.test' was left open.
[0m14:17:54.326962 [debug] [MainThread]: On model.dbt_rg_snowflake.test: Close
[0m14:17:54.560858 [info ] [MainThread]: 
[0m14:17:54.561522 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.30 seconds (12.30s).
[0m14:17:54.562343 [debug] [MainThread]: Command end result
[0m14:17:54.584244 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:17:54.585424 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:17:54.589374 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/run_results.json
[0m14:17:54.589570 [info ] [MainThread]: 
[0m14:17:54.589790 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:17:54.589948 [info ] [MainThread]: 
[0m14:17:54.590128 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m14:17:54.593111 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 13.599671, "process_in_blocks": "0", "process_kernel_time": 0.287425, "process_mem_max_rss": "234471424", "process_out_blocks": "0", "process_user_time": 1.776696}
[0m14:17:54.593471 [debug] [MainThread]: Command `dbt run` succeeded at 14:17:54.593393 after 13.60 seconds
[0m14:17:54.593712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11541cff0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1154f5ac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc4d050>]}
[0m14:17:54.593917 [debug] [MainThread]: Flushing usage events
[0m14:17:55.420222 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:21:24.505894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103c73a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10519b890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10519bb10>]}


============================== 14:21:24.508546 | 920ebd06-8e99-4c12-a082-46c10c65c5dd ==============================
[0m14:21:24.508546 [info ] [MainThread]: Running with dbt=1.10.11
[0m14:21:24.508816 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'indirect_selection': 'eager', 'static_parser': 'True', 'write_json': 'True', 'introspect': 'True', 'cache_selected_only': 'False', 'use_colors': 'True', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'target_path': 'None', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:daily', 'no_print': 'None', 'warn_error': 'None', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'version_check': 'True', 'fail_fast': 'False', 'printer_width': '80', 'debug': 'False', 'log_cache_events': 'False', 'quiet': 'False'}
[0m14:21:25.138518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '920ebd06-8e99-4c12-a082-46c10c65c5dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1044ab5c0>]}
[0m14:21:25.161199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '920ebd06-8e99-4c12-a082-46c10c65c5dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b65c6b0>]}
[0m14:21:25.161717 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m14:21:25.217715 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m14:21:25.248120 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m14:21:25.248340 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '920ebd06-8e99-4c12-a082-46c10c65c5dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b60d450>]}
[0m14:21:25.749856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '920ebd06-8e99-4c12-a082-46c10c65c5dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bb08320>]}
[0m14:21:25.773788 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:21:25.775047 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:21:25.784879 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '920ebd06-8e99-4c12-a082-46c10c65c5dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bdc9a90>]}
[0m14:21:25.785070 [info ] [MainThread]: Found 1 model, 596 macros
[0m14:21:25.785207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '920ebd06-8e99-4c12-a082-46c10c65c5dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bd0fee0>]}
[0m14:21:25.785812 [info ] [MainThread]: 
[0m14:21:25.785945 [info ] [MainThread]: Concurrency: 4 threads (target='prod')
[0m14:21:25.786052 [info ] [MainThread]: 
[0m14:21:25.786241 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m14:21:25.786566 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG'
[0m14:21:25.815613 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG"
[0m14:21:25.815797 [debug] [ThreadPool]: On list_FD_IO_DLK_RG: show terse schemas in database FD_IO_DLK_RG
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG"} */
[0m14:21:25.815904 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:21:28.738606 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 2.922 seconds
[0m14:21:28.742480 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG, now list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION)
[0m14:21:28.757939 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"
[0m14:21:28.758364 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION: show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"} */;
[0m14:21:29.577792 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.819 seconds
[0m14:21:29.580898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '920ebd06-8e99-4c12-a082-46c10c65c5dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113119850>]}
[0m14:21:29.585525 [debug] [Thread-1 (]: Began running node model.dbt_rg_snowflake.test
[0m14:21:29.586366 [info ] [Thread-1 (]: 1 of 1 START sql table model DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test  [RUN]
[0m14:21:29.586979 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m14:21:29.587394 [debug] [Thread-1 (]: Began compiling node model.dbt_rg_snowflake.test
[0m14:21:29.595548 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m14:21:29.596513 [debug] [Thread-1 (]: Began executing node model.dbt_rg_snowflake.test
[0m14:21:29.621812 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_rg_snowflake.test"
[0m14:21:29.630249 [debug] [Thread-1 (]: Using snowflake connection "model.dbt_rg_snowflake.test"
[0m14:21:29.630891 [debug] [Thread-1 (]: On model.dbt_rg_snowflake.test: create or replace transient table FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test
    
    
    
    as (--CREATE OR REPLACE TABLE FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.agg_ticket_rg AS (

WITH first_ticket as (
    SELECT master_customer_id,
           min(purchase_date) as date_first_ticket
    from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg
    group by master_customer_id
)

SELECT a.master_customer_id, 
       
       min(purchase_date) as date_first_purchase,
       max(purchase_date) as date_last_purchase,
       AVG(DATEDIFF(DAY, lag_date_purchase, purchase_date)) as avg_delta_jour,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_web end ) AS amount_including_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then amount_including_taxes_mag end ) AS amount_including_taxes_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_day end ) AS amount_including_taxes_12m, 
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_ticket_web end ) AS nb_ticket_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket_mag end ) AS nb_ticket_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket end ) AS nb_ticket_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_achat_actif end ) AS nb_achat_actif_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  margin_excluding_taxes end ) as margin_excluding_taxes_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_web end ) as margin_excluding_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_mag end ) as margin_excluding_taxes_mag_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_web end ) AS nb_product_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_mag end ) AS nb_product_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte end ) AS nb_product_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_art end ) as nb_art_12m,
       sum(abs(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_retour end )) as nb_retour_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_markdown_including_taxes end ) as customer_markdown_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_discount_including_taxes end ) as customer_discount_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then initial_selling_price end ) as initial_selling_price_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  Total_Discount end )  as Total_Discount_12M,

       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_0_6m, 
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte else 0 end) AS nb_product_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_art else 0 end) as nb_art_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_0_6m,

       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_6_12m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte else 0 end) AS nb_product_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_art else 0 end) as nb_art_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_6_12m,
       
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_12m_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_12_18m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte else 0 end) AS nb_product_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_art else 0 end) as nb_art_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_12_18m,    

       SUM(case when(purchase_date = date_first_ticket) then amount_including_taxes_day else 0 end) AS amount_including_taxes_first_ticket, 
       SUM(case when(purchase_date = date_first_ticket) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_first_ticket,
       SUM(case when(purchase_date = date_first_ticket) then qte else 0 end) AS nb_product_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then nb_art else 0 end) as nb_art_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then initial_selling_price else 0 end) as initial_selling_price_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then Total_Discount else 0 end) as Total_Discount_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then amount_ventes else 0 end) as amount_ventes_first_ticket
      
from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg a
left join first_ticket b
on a.master_customer_id = b.master_customer_id

where purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)
and purchase_date >= b.date_first_ticket
group by a.master_customer_id

--)
    )

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "node_id": "model.dbt_rg_snowflake.test"} */;
[0m14:21:33.992312 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.360 seconds
[0m14:21:34.017511 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '920ebd06-8e99-4c12-a082-46c10c65c5dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11327f070>]}
[0m14:21:34.017977 [info ] [Thread-1 (]: 1 of 1 OK created sql table model DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test  [[32mSUCCESS 1[0m in 4.43s]
[0m14:21:34.018331 [debug] [Thread-1 (]: Finished running node model.dbt_rg_snowflake.test
[0m14:21:34.019176 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:21:34.019415 [debug] [MainThread]: Connection 'model.dbt_rg_snowflake.test' was left open.
[0m14:21:34.019603 [debug] [MainThread]: On model.dbt_rg_snowflake.test: Close
[0m14:21:34.182966 [info ] [MainThread]: 
[0m14:21:34.183455 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 8.40 seconds (8.40s).
[0m14:21:34.184132 [debug] [MainThread]: Command end result
[0m14:21:34.204364 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:21:34.205683 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:21:34.209429 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/run_results.json
[0m14:21:34.209601 [info ] [MainThread]: 
[0m14:21:34.209801 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:21:34.209948 [info ] [MainThread]: 
[0m14:21:34.210117 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m14:21:34.213015 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 9.74317, "process_in_blocks": "0", "process_kernel_time": 0.285307, "process_mem_max_rss": "231669760", "process_out_blocks": "0", "process_user_time": 1.772817}
[0m14:21:34.213315 [debug] [MainThread]: Command `dbt run` succeeded at 14:21:34.213261 after 9.74 seconds
[0m14:21:34.213529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113222c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1132ed7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bd803d0>]}
[0m14:21:34.213726 [debug] [MainThread]: Flushing usage events
[0m14:21:34.854927 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:32:22.984593 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057f7a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107337890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107337b10>]}


============================== 14:32:22.987303 | 87673b5e-b5a6-4b64-b0f6-affc21d93fff ==============================
[0m14:32:22.987303 [info ] [MainThread]: Running with dbt=1.10.11
[0m14:32:22.987577 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'partial_parse': 'True', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'no_print': 'None', 'printer_width': '80', 'empty': 'False', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'invocation_command': 'dbt run --select tag:daily', 'use_experimental_parser': 'False', 'version_check': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'debug': 'False', 'indirect_selection': 'eager', 'log_format': 'default', 'warn_error': 'None', 'use_colors': 'True', 'write_json': 'True', 'static_parser': 'True', 'quiet': 'False', 'fail_fast': 'False'}
[0m14:32:23.583796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '87673b5e-b5a6-4b64-b0f6-affc21d93fff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1062475c0>]}
[0m14:32:23.605688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '87673b5e-b5a6-4b64-b0f6-affc21d93fff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1173986b0>]}
[0m14:32:23.606142 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m14:32:23.660617 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m14:32:23.724279 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:32:23.724462 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:32:23.734256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '87673b5e-b5a6-4b64-b0f6-affc21d93fff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x117349c50>]}
[0m14:32:23.758828 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:32:23.759850 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:32:23.769052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '87673b5e-b5a6-4b64-b0f6-affc21d93fff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11730ed50>]}
[0m14:32:23.769215 [info ] [MainThread]: Found 1 model, 596 macros
[0m14:32:23.769351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87673b5e-b5a6-4b64-b0f6-affc21d93fff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11738af90>]}
[0m14:32:23.770172 [info ] [MainThread]: 
[0m14:32:23.770309 [info ] [MainThread]: Concurrency: 4 threads (target='prod')
[0m14:32:23.770416 [info ] [MainThread]: 
[0m14:32:23.770608 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m14:32:23.770943 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG'
[0m14:32:23.800431 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG"
[0m14:32:23.800621 [debug] [ThreadPool]: On list_FD_IO_DLK_RG: show terse schemas in database FD_IO_DLK_RG
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG"} */
[0m14:32:23.800732 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:32:27.023195 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 3.222 seconds
[0m14:32:27.027222 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG, now list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION)
[0m14:32:27.044108 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"
[0m14:32:27.044621 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION: show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"} */;
[0m14:32:27.256532 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.211 seconds
[0m14:32:27.260385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87673b5e-b5a6-4b64-b0f6-affc21d93fff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12213e1a0>]}
[0m14:32:27.265962 [debug] [Thread-1 (]: Began running node model.dbt_rg_snowflake.test
[0m14:32:27.266663 [info ] [Thread-1 (]: 1 of 1 START sql table model DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test  [RUN]
[0m14:32:27.267227 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m14:32:27.267730 [debug] [Thread-1 (]: Began compiling node model.dbt_rg_snowflake.test
[0m14:32:27.275947 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m14:32:27.277018 [debug] [Thread-1 (]: Began executing node model.dbt_rg_snowflake.test
[0m14:32:27.301808 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_rg_snowflake.test"
[0m14:32:27.310528 [debug] [Thread-1 (]: Using snowflake connection "model.dbt_rg_snowflake.test"
[0m14:32:27.311179 [debug] [Thread-1 (]: On model.dbt_rg_snowflake.test: create or replace transient table FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test
    
    
    
    as (--CREATE OR REPLACE TABLE FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.agg_ticket_rg AS (

WITH first_ticket as (
    SELECT master_customer_id,
           min(purchase_date) as date_first_ticket
    from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg
    group by master_customer_id
)

SELECT a.master_customer_id, 
       
       min(purchase_date) as date_first_purchase,
       max(purchase_date) as date_last_purchase,
       AVG(DATEDIFF(DAY, lag_date_purchase, purchase_date)) as avg_delta_jour,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_web end ) AS amount_including_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then amount_including_taxes_mag end ) AS amount_including_taxes_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_day end ) AS amount_including_taxes_12m, 
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_ticket_web end ) AS nb_ticket_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket_mag end ) AS nb_ticket_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket end ) AS nb_ticket_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_achat_actif end ) AS nb_achat_actif_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  margin_excluding_taxes end ) as margin_excluding_taxes_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_web end ) as margin_excluding_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_mag end ) as margin_excluding_taxes_mag_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_web end ) AS nb_product_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_mag end ) AS nb_product_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte end ) AS nb_product_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_art end ) as nb_art_12m,
       sum(abs(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_retour end )) as nb_retour_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_markdown_including_taxes end ) as customer_markdown_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_discount_including_taxes end ) as customer_discount_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then initial_selling_price end ) as initial_selling_price_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  Total_Discount end )  as Total_Discount_12M,

       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_0_6m, 
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte else 0 end) AS nb_product_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_art else 0 end) as nb_art_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_0_6m,

       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_6_12m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte else 0 end) AS nb_product_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_art else 0 end) as nb_art_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_6_12m,
       
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_12m_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_12_18m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte else 0 end) AS nb_product_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_art else 0 end) as nb_art_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_12_18m,    

       SUM(case when(purchase_date = date_first_ticket) then amount_including_taxes_day else 0 end) AS amount_including_taxes_first_ticket, 
       SUM(case when(purchase_date = date_first_ticket) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_first_ticket,
       SUM(case when(purchase_date = date_first_ticket) then qte else 0 end) AS nb_product_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then nb_art else 0 end) as nb_art_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then initial_selling_price else 0 end) as initial_selling_price_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then Total_Discount else 0 end) as Total_Discount_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then amount_ventes else 0 end) as amount_ventes_first_ticket
      
from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg a
left join first_ticket b
on a.master_customer_id = b.master_customer_id

where purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)
and purchase_date >= b.date_first_ticket
group by a.master_customer_id

--)
    )

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "node_id": "model.dbt_rg_snowflake.test"} */;
[0m14:32:33.136280 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 5.824 seconds
[0m14:32:33.170327 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '87673b5e-b5a6-4b64-b0f6-affc21d93fff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x120ff6ed0>]}
[0m14:32:33.170930 [info ] [Thread-1 (]: 1 of 1 OK created sql table model DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test  [[32mSUCCESS 1[0m in 5.90s]
[0m14:32:33.171402 [debug] [Thread-1 (]: Finished running node model.dbt_rg_snowflake.test
[0m14:32:33.172387 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:32:33.172586 [debug] [MainThread]: Connection 'model.dbt_rg_snowflake.test' was left open.
[0m14:32:33.172769 [debug] [MainThread]: On model.dbt_rg_snowflake.test: Close
[0m14:32:33.351477 [info ] [MainThread]: 
[0m14:32:33.352099 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.58 seconds (9.58s).
[0m14:32:33.352895 [debug] [MainThread]: Command end result
[0m14:32:33.376033 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:32:33.377335 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:32:33.381320 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/run_results.json
[0m14:32:33.381497 [info ] [MainThread]: 
[0m14:32:33.381715 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:32:33.381869 [info ] [MainThread]: 
[0m14:32:33.382054 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m14:32:33.385079 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 10.4356, "process_in_blocks": "0", "process_kernel_time": 0.282046, "process_mem_max_rss": "226426880", "process_out_blocks": "0", "process_user_time": 1.320494}
[0m14:32:33.385388 [debug] [MainThread]: Command `dbt run` succeeded at 14:32:33.385328 after 10.44 seconds
[0m14:32:33.385605 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x122356200>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1203ef570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1203eead0>]}
[0m14:32:33.385811 [debug] [MainThread]: Flushing usage events
[0m14:32:33.971398 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:33:45.235982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103affa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105637890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105637b10>]}


============================== 14:33:45.238353 | c705fedf-1cbd-40b5-99f9-f42023183334 ==============================
[0m14:33:45.238353 [info ] [MainThread]: Running with dbt=1.10.11
[0m14:33:45.238622 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'printer_width': '80', 'version_check': 'True', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'use_experimental_parser': 'False', 'cache_selected_only': 'False', 'invocation_command': 'dbt run --select tag:daily', 'debug': 'False', 'quiet': 'False', 'use_colors': 'True', 'fail_fast': 'False', 'warn_error': 'None', 'log_format': 'default', 'no_print': 'None', 'log_cache_events': 'False', 'write_json': 'True', 'static_parser': 'True', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'partial_parse': 'True', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m14:33:45.806422 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c705fedf-1cbd-40b5-99f9-f42023183334', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045435c0>]}
[0m14:33:45.829126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c705fedf-1cbd-40b5-99f9-f42023183334', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d6986b0>]}
[0m14:33:45.830193 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m14:33:45.886523 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m14:33:45.917118 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m14:33:45.917360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'c705fedf-1cbd-40b5-99f9-f42023183334', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d649450>]}
[0m14:33:46.413844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c705fedf-1cbd-40b5-99f9-f42023183334', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11dc4c320>]}
[0m14:33:46.438145 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:33:46.439161 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:33:46.448231 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c705fedf-1cbd-40b5-99f9-f42023183334', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11e005a90>]}
[0m14:33:46.448419 [info ] [MainThread]: Found 1 model, 596 macros
[0m14:33:46.448552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c705fedf-1cbd-40b5-99f9-f42023183334', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11df2bee0>]}
[0m14:33:46.449141 [info ] [MainThread]: 
[0m14:33:46.449276 [info ] [MainThread]: Concurrency: 4 threads (target='prod')
[0m14:33:46.449381 [info ] [MainThread]: 
[0m14:33:46.449565 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m14:33:46.449888 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG'
[0m14:33:46.478415 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG"
[0m14:33:46.478596 [debug] [ThreadPool]: On list_FD_IO_DLK_RG: show terse schemas in database FD_IO_DLK_RG
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG"} */
[0m14:33:46.478705 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:33:49.341430 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 2.862 seconds
[0m14:33:49.345484 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG, now list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION)
[0m14:33:49.361620 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"
[0m14:33:49.362053 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION: show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION"} */;
[0m14:33:49.576572 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.214 seconds
[0m14:33:49.580971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c705fedf-1cbd-40b5-99f9-f42023183334', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11f719850>]}
[0m14:33:49.586730 [debug] [Thread-1 (]: Began running node model.dbt_rg_snowflake.test
[0m14:33:49.587439 [info ] [Thread-1 (]: 1 of 1 START sql table model DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test  [RUN]
[0m14:33:49.588156 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m14:33:49.588657 [debug] [Thread-1 (]: Began compiling node model.dbt_rg_snowflake.test
[0m14:33:49.596970 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m14:33:49.597924 [debug] [Thread-1 (]: Began executing node model.dbt_rg_snowflake.test
[0m14:33:49.622417 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_rg_snowflake.test"
[0m14:33:49.630681 [debug] [Thread-1 (]: Using snowflake connection "model.dbt_rg_snowflake.test"
[0m14:33:49.631307 [debug] [Thread-1 (]: On model.dbt_rg_snowflake.test: create or replace transient table FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test
    
    
    
    as (--CREATE OR REPLACE TABLE FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.agg_ticket_rg AS (

WITH first_ticket as (
    SELECT master_customer_id,
           min(purchase_date) as date_first_ticket
    from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg
    group by master_customer_id
)

SELECT a.master_customer_id, 
       
       min(purchase_date) as date_first_purchase,
       max(purchase_date) as date_last_purchase,
       AVG(DATEDIFF(DAY, lag_date_purchase, purchase_date)) as avg_delta_jour,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_web end ) AS amount_including_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then amount_including_taxes_mag end ) AS amount_including_taxes_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_day end ) AS amount_including_taxes_12m, 
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_ticket_web end ) AS nb_ticket_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket_mag end ) AS nb_ticket_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket end ) AS nb_ticket_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_achat_actif end ) AS nb_achat_actif_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  margin_excluding_taxes end ) as margin_excluding_taxes_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_web end ) as margin_excluding_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_mag end ) as margin_excluding_taxes_mag_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_web end ) AS nb_product_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_mag end ) AS nb_product_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte end ) AS nb_product_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_art end ) as nb_art_12m,
       sum(abs(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_retour end )) as nb_retour_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_markdown_including_taxes end ) as customer_markdown_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_discount_including_taxes end ) as customer_discount_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then initial_selling_price end ) as initial_selling_price_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  Total_Discount end )  as Total_Discount_12M,

       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_0_6m, 
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte else 0 end) AS nb_product_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_art else 0 end) as nb_art_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_0_6m,

       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_6_12m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte else 0 end) AS nb_product_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_art else 0 end) as nb_art_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_6_12m,
       
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_12m_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_12_18m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte else 0 end) AS nb_product_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_art else 0 end) as nb_art_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_12_18m,    

       SUM(case when(purchase_date = date_first_ticket) then amount_including_taxes_day else 0 end) AS amount_including_taxes_first_ticket, 
       SUM(case when(purchase_date = date_first_ticket) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_first_ticket,
       SUM(case when(purchase_date = date_first_ticket) then qte else 0 end) AS nb_product_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then nb_art else 0 end) as nb_art_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then initial_selling_price else 0 end) as initial_selling_price_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then Total_Discount else 0 end) as Total_Discount_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then amount_ventes else 0 end) as amount_ventes_first_ticket
      
from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg a
left join first_ticket b
on a.master_customer_id = b.master_customer_id

where purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)
and purchase_date >= b.date_first_ticket
group by a.master_customer_id

--)
    )

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "node_id": "model.dbt_rg_snowflake.test"} */;
[0m14:33:54.451701 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.819 seconds
[0m14:33:54.485331 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c705fedf-1cbd-40b5-99f9-f42023183334', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12887f070>]}
[0m14:33:54.485979 [info ] [Thread-1 (]: 1 of 1 OK created sql table model DLK_RG_BDA_ACQUISITION_DLK_RG_BDA_ACQUISITION.test  [[32mSUCCESS 1[0m in 4.90s]
[0m14:33:54.486414 [debug] [Thread-1 (]: Finished running node model.dbt_rg_snowflake.test
[0m14:33:54.487409 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:33:54.487626 [debug] [MainThread]: Connection 'model.dbt_rg_snowflake.test' was left open.
[0m14:33:54.487809 [debug] [MainThread]: On model.dbt_rg_snowflake.test: Close
[0m14:33:54.912453 [info ] [MainThread]: 
[0m14:33:54.913582 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 8.46 seconds (8.46s).
[0m14:33:54.914790 [debug] [MainThread]: Command end result
[0m14:33:54.941657 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:33:54.943174 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:33:54.947194 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/run_results.json
[0m14:33:54.947403 [info ] [MainThread]: 
[0m14:33:54.947640 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:33:54.947815 [info ] [MainThread]: 
[0m14:33:54.948012 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m14:33:54.950946 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 9.750438, "process_in_blocks": "0", "process_kernel_time": 0.278229, "process_mem_max_rss": "234012672", "process_out_blocks": "0", "process_user_time": 1.793141}
[0m14:33:54.951207 [debug] [MainThread]: Command `dbt run` succeeded at 14:33:54.951157 after 9.75 seconds
[0m14:33:54.951416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x128822c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1288ed7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11dfbc3d0>]}
[0m14:33:54.951616 [debug] [MainThread]: Flushing usage events
[0m14:33:55.531517 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:35:01.189422 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103aa3a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104fcb890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104fcbb10>]}


============================== 14:35:01.191783 | a9f0fa63-b6eb-4b5b-a8b8-634466dee89e ==============================
[0m14:35:01.191783 [info ] [MainThread]: Running with dbt=1.10.11
[0m14:35:01.192040 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'version_check': 'True', 'log_format': 'default', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'quiet': 'False', 'cache_selected_only': 'False', 'indirect_selection': 'eager', 'use_colors': 'True', 'log_cache_events': 'False', 'invocation_command': 'dbt run --select tag:daily', 'write_json': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'introspect': 'True', 'warn_error': 'None', 'target_path': 'None', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'fail_fast': 'False', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'printer_width': '80', 'static_parser': 'True'}
[0m14:35:01.570394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a9f0fa63-b6eb-4b5b-a8b8-634466dee89e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1042db5c0>]}
[0m14:35:01.593087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a9f0fa63-b6eb-4b5b-a8b8-634466dee89e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b48c6b0>]}
[0m14:35:01.593426 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m14:35:01.645766 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m14:35:01.687099 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:35:01.687409 [debug] [MainThread]: Partial parsing: updated file: dbt_rg_snowflake://models/warmup/test.yml
[0m14:35:01.796495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a9f0fa63-b6eb-4b5b-a8b8-634466dee89e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b43da50>]}
[0m14:35:01.820116 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:35:01.820925 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:35:01.826066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a9f0fa63-b6eb-4b5b-a8b8-634466dee89e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b402d50>]}
[0m14:35:01.826248 [info ] [MainThread]: Found 1 model, 596 macros
[0m14:35:01.826385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a9f0fa63-b6eb-4b5b-a8b8-634466dee89e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b47e890>]}
[0m14:35:01.827203 [info ] [MainThread]: 
[0m14:35:01.827339 [info ] [MainThread]: Concurrency: 4 threads (target='prod')
[0m14:35:01.827446 [info ] [MainThread]: 
[0m14:35:01.827632 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m14:35:01.827952 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG'
[0m14:35:01.849624 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG"
[0m14:35:01.849822 [debug] [ThreadPool]: On list_FD_IO_DLK_RG: show terse schemas in database FD_IO_DLK_RG
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG"} */
[0m14:35:01.849935 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:35:04.577590 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 2.727 seconds
[0m14:35:04.580429 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG, now list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION)
[0m14:35:04.592342 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m14:35:04.592641 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */;
[0m14:35:04.761920 [debug] [ThreadPool]: SQL status: SUCCESS 10 in 0.169 seconds
[0m14:35:04.768961 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a9f0fa63-b6eb-4b5b-a8b8-634466dee89e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112e13040>]}
[0m14:35:04.771319 [debug] [Thread-1 (]: Began running node model.dbt_rg_snowflake.test
[0m14:35:04.771822 [info ] [Thread-1 (]: 1 of 1 START sql table model DLK_RG_BDA_ACQUISITION.test ....................... [RUN]
[0m14:35:04.772219 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m14:35:04.772534 [debug] [Thread-1 (]: Began compiling node model.dbt_rg_snowflake.test
[0m14:35:04.778702 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m14:35:04.779482 [debug] [Thread-1 (]: Began executing node model.dbt_rg_snowflake.test
[0m14:35:04.801293 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_rg_snowflake.test"
[0m14:35:04.809145 [debug] [Thread-1 (]: Using snowflake connection "model.dbt_rg_snowflake.test"
[0m14:35:04.809742 [debug] [Thread-1 (]: On model.dbt_rg_snowflake.test: create or replace transient table FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.test
    
    
    
    as (--CREATE OR REPLACE TABLE FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.agg_ticket_rg AS (

WITH first_ticket as (
    SELECT master_customer_id,
           min(purchase_date) as date_first_ticket
    from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg
    group by master_customer_id
)

SELECT a.master_customer_id, 
       
       min(purchase_date) as date_first_purchase,
       max(purchase_date) as date_last_purchase,
       AVG(DATEDIFF(DAY, lag_date_purchase, purchase_date)) as avg_delta_jour,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_web end ) AS amount_including_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then amount_including_taxes_mag end ) AS amount_including_taxes_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_day end ) AS amount_including_taxes_12m, 
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_ticket_web end ) AS nb_ticket_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket_mag end ) AS nb_ticket_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket end ) AS nb_ticket_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_achat_actif end ) AS nb_achat_actif_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  margin_excluding_taxes end ) as margin_excluding_taxes_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_web end ) as margin_excluding_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_mag end ) as margin_excluding_taxes_mag_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_web end ) AS nb_product_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_mag end ) AS nb_product_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte end ) AS nb_product_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_art end ) as nb_art_12m,
       sum(abs(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_retour end )) as nb_retour_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_markdown_including_taxes end ) as customer_markdown_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_discount_including_taxes end ) as customer_discount_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then initial_selling_price end ) as initial_selling_price_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  Total_Discount end )  as Total_Discount_12M,

       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_0_6m, 
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte else 0 end) AS nb_product_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_art else 0 end) as nb_art_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_0_6m,

       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_6_12m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte else 0 end) AS nb_product_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_art else 0 end) as nb_art_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_6_12m,
       
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_12m_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_12_18m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte else 0 end) AS nb_product_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_art else 0 end) as nb_art_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_12_18m,    

       SUM(case when(purchase_date = date_first_ticket) then amount_including_taxes_day else 0 end) AS amount_including_taxes_first_ticket, 
       SUM(case when(purchase_date = date_first_ticket) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_first_ticket,
       SUM(case when(purchase_date = date_first_ticket) then qte else 0 end) AS nb_product_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then nb_art else 0 end) as nb_art_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then initial_selling_price else 0 end) as initial_selling_price_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then Total_Discount else 0 end) as Total_Discount_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then amount_ventes else 0 end) as amount_ventes_first_ticket
      
from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg a
left join first_ticket b
on a.master_customer_id = b.master_customer_id

where purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)
and purchase_date >= b.date_first_ticket
group by a.master_customer_id

--)
    )

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "node_id": "model.dbt_rg_snowflake.test"} */;
[0m14:35:08.242195 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.432 seconds
[0m14:35:08.256966 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a9f0fa63-b6eb-4b5b-a8b8-634466dee89e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ee0650>]}
[0m14:35:08.257394 [info ] [Thread-1 (]: 1 of 1 OK created sql table model DLK_RG_BDA_ACQUISITION.test .................. [[32mSUCCESS 1[0m in 3.48s]
[0m14:35:08.257683 [debug] [Thread-1 (]: Finished running node model.dbt_rg_snowflake.test
[0m14:35:08.258379 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:35:08.258569 [debug] [MainThread]: Connection 'model.dbt_rg_snowflake.test' was left open.
[0m14:35:08.258714 [debug] [MainThread]: On model.dbt_rg_snowflake.test: Close
[0m14:35:08.458581 [info ] [MainThread]: 
[0m14:35:08.459594 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.63 seconds (6.63s).
[0m14:35:08.460478 [debug] [MainThread]: Command end result
[0m14:35:08.482813 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:35:08.484118 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:35:08.487632 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/run_results.json
[0m14:35:08.487817 [info ] [MainThread]: 
[0m14:35:08.488032 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:35:08.488193 [info ] [MainThread]: 
[0m14:35:08.488370 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m14:35:08.491092 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 7.3355856, "process_in_blocks": "0", "process_kernel_time": 0.216923, "process_mem_max_rss": "230965248", "process_out_blocks": "0", "process_user_time": 1.404022}
[0m14:35:08.491347 [debug] [MainThread]: Command `dbt run` succeeded at 14:35:08.491299 after 7.34 seconds
[0m14:35:08.491543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b994c00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112eeb7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112eeb6b0>]}
[0m14:35:08.491734 [debug] [MainThread]: Flushing usage events
[0m14:35:09.029205 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:35:52.774164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103b4fa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105077890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105077b10>]}


============================== 14:35:52.776766 | 933490a4-863c-470f-aacc-b8e38f80c96e ==============================
[0m14:35:52.776766 [info ] [MainThread]: Running with dbt=1.10.11
[0m14:35:52.777045 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'send_anonymous_usage_stats': 'True', 'target_path': 'None', 'log_format': 'default', 'use_experimental_parser': 'False', 'no_print': 'None', 'empty': 'False', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'partial_parse': 'True', 'write_json': 'True', 'warn_error': 'None', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'debug': 'False', 'quiet': 'False', 'version_check': 'True', 'cache_selected_only': 'False', 'log_cache_events': 'False', 'fail_fast': 'False', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'invocation_command': 'dbt run --select tag:daily', 'use_colors': 'True', 'indirect_selection': 'eager'}
[0m14:35:53.398964 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '933490a4-863c-470f-aacc-b8e38f80c96e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1043875c0>]}
[0m14:35:53.421054 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '933490a4-863c-470f-aacc-b8e38f80c96e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5386b0>]}
[0m14:35:53.421545 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m14:35:53.476927 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m14:35:53.507368 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m14:35:53.507601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '933490a4-863c-470f-aacc-b8e38f80c96e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4e9450>]}
[0m14:35:54.015900 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '933490a4-863c-470f-aacc-b8e38f80c96e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4af7a0>]}
[0m14:35:54.039850 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:35:54.040909 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:35:54.050305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '933490a4-863c-470f-aacc-b8e38f80c96e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bcef3f0>]}
[0m14:35:54.050488 [info ] [MainThread]: Found 1 model, 596 macros
[0m14:35:54.050620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '933490a4-863c-470f-aacc-b8e38f80c96e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bd97ee0>]}
[0m14:35:54.051217 [info ] [MainThread]: 
[0m14:35:54.051356 [info ] [MainThread]: Concurrency: 4 threads (target='prod')
[0m14:35:54.051462 [info ] [MainThread]: 
[0m14:35:54.051647 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m14:35:54.051977 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG'
[0m14:35:54.082636 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG"
[0m14:35:54.082834 [debug] [ThreadPool]: On list_FD_IO_DLK_RG: show terse schemas in database FD_IO_DLK_RG
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG"} */
[0m14:35:54.082957 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:36:53.652496 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 59.569 seconds
[0m14:36:53.655445 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG, now list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION)
[0m14:36:53.668772 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m14:36:53.668997 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */;
[0m14:36:53.911961 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 0.243 seconds
[0m14:36:53.917839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '933490a4-863c-470f-aacc-b8e38f80c96e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113027f50>]}
[0m14:36:53.922165 [debug] [Thread-1 (]: Began running node model.dbt_rg_snowflake.test
[0m14:36:53.922865 [info ] [Thread-1 (]: 1 of 1 START sql table model DLK_RG_BDA_ACQUISITION.test ....................... [RUN]
[0m14:36:53.923458 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m14:36:53.923893 [debug] [Thread-1 (]: Began compiling node model.dbt_rg_snowflake.test
[0m14:36:53.930820 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m14:36:53.931898 [debug] [Thread-1 (]: Began executing node model.dbt_rg_snowflake.test
[0m14:36:53.954031 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_rg_snowflake.test"
[0m14:36:53.962475 [debug] [Thread-1 (]: Using snowflake connection "model.dbt_rg_snowflake.test"
[0m14:36:53.963124 [debug] [Thread-1 (]: On model.dbt_rg_snowflake.test: create or replace transient table FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.test
    
    
    
    as (--CREATE OR REPLACE TABLE FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.agg_ticket_rg AS (

WITH first_ticket as (
    SELECT master_customer_id,
           min(purchase_date) as date_first_ticket
    from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg
    group by master_customer_id
)

SELECT a.master_customer_id, 
       
       min(purchase_date) as date_first_purchase,
       max(purchase_date) as date_last_purchase,
       AVG(DATEDIFF(DAY, lag_date_purchase, purchase_date)) as avg_delta_jour,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_web end ) AS amount_including_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then amount_including_taxes_mag end ) AS amount_including_taxes_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_day end ) AS amount_including_taxes_12m, 
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_ticket_web end ) AS nb_ticket_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket_mag end ) AS nb_ticket_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket end ) AS nb_ticket_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_achat_actif end ) AS nb_achat_actif_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  margin_excluding_taxes end ) as margin_excluding_taxes_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_web end ) as margin_excluding_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_mag end ) as margin_excluding_taxes_mag_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_web end ) AS nb_product_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_mag end ) AS nb_product_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte end ) AS nb_product_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_art end ) as nb_art_12m,
       sum(abs(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_retour end )) as nb_retour_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_markdown_including_taxes end ) as customer_markdown_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_discount_including_taxes end ) as customer_discount_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then initial_selling_price end ) as initial_selling_price_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  Total_Discount end )  as Total_Discount_12M,

       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_0_6m, 
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte else 0 end) AS nb_product_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_art else 0 end) as nb_art_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_0_6m,

       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_6_12m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte else 0 end) AS nb_product_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_art else 0 end) as nb_art_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_6_12m,
       
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_12m_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_12_18m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte else 0 end) AS nb_product_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_art else 0 end) as nb_art_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_12_18m,    

       SUM(case when(purchase_date = date_first_ticket) then amount_including_taxes_day else 0 end) AS amount_including_taxes_first_ticket, 
       SUM(case when(purchase_date = date_first_ticket) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_first_ticket,
       SUM(case when(purchase_date = date_first_ticket) then qte else 0 end) AS nb_product_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then nb_art else 0 end) as nb_art_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then initial_selling_price else 0 end) as initial_selling_price_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then Total_Discount else 0 end) as Total_Discount_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then amount_ventes else 0 end) as amount_ventes_first_ticket
      
from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg a
left join first_ticket b
on a.master_customer_id = b.master_customer_id

where purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)
and purchase_date >= b.date_first_ticket
group by a.master_customer_id

--)
    )

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "node_id": "model.dbt_rg_snowflake.test"} */;
[0m14:36:58.067037 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.103 seconds
[0m14:36:58.101197 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '933490a4-863c-470f-aacc-b8e38f80c96e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113187d80>]}
[0m14:36:58.101834 [info ] [Thread-1 (]: 1 of 1 OK created sql table model DLK_RG_BDA_ACQUISITION.test .................. [[32mSUCCESS 1[0m in 4.18s]
[0m14:36:58.102259 [debug] [Thread-1 (]: Finished running node model.dbt_rg_snowflake.test
[0m14:36:58.103268 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:36:58.103473 [debug] [MainThread]: Connection 'model.dbt_rg_snowflake.test' was left open.
[0m14:36:58.103660 [debug] [MainThread]: On model.dbt_rg_snowflake.test: Close
[0m14:36:58.770407 [info ] [MainThread]: 
[0m14:36:58.770938 [info ] [MainThread]: Finished running 1 table model in 0 hours 1 minutes and 4.72 seconds (64.72s).
[0m14:36:58.771587 [debug] [MainThread]: Command end result
[0m14:36:58.795030 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:36:58.796773 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:36:58.800307 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/run_results.json
[0m14:36:58.800578 [info ] [MainThread]: 
[0m14:36:58.800881 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:36:58.801103 [info ] [MainThread]: 
[0m14:36:58.801358 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m14:36:58.805020 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 66.066345, "process_in_blocks": "0", "process_kernel_time": 0.316655, "process_mem_max_rss": "229933056", "process_out_blocks": "0", "process_user_time": 2.041823}
[0m14:36:58.805330 [debug] [MainThread]: Command `dbt run` succeeded at 14:36:58.805275 after 66.07 seconds
[0m14:36:58.805579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11315e490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131f6690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bb9d650>]}
[0m14:36:58.805823 [debug] [MainThread]: Flushing usage events
[0m14:36:59.438408 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:40:02.703626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10754fa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109337890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109337b10>]}


============================== 14:40:02.706340 | 707b9f77-30c3-439d-bb24-3c2ca32f272e ==============================
[0m14:40:02.706340 [info ] [MainThread]: Running with dbt=1.10.11
[0m14:40:02.706605 [debug] [MainThread]: running dbt with arguments {'quiet': 'False', 'printer_width': '80', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'fail_fast': 'False', 'partial_parse': 'True', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'version_check': 'True', 'target_path': 'None', 'indirect_selection': 'eager', 'use_colors': 'True', 'write_json': 'True', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'warn_error': 'None', 'debug': 'False', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:daily', 'static_parser': 'True', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'no_print': 'None', 'log_format': 'default'}
[0m14:40:03.302110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '707b9f77-30c3-439d-bb24-3c2ca32f272e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082475c0>]}
[0m14:40:03.324204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '707b9f77-30c3-439d-bb24-3c2ca32f272e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1194986b0>]}
[0m14:40:03.324670 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m14:40:03.380859 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m14:40:03.444441 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:40:03.444614 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:40:03.454510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '707b9f77-30c3-439d-bb24-3c2ca32f272e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x119449c50>]}
[0m14:40:03.479018 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:40:03.480031 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:40:03.489451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '707b9f77-30c3-439d-bb24-3c2ca32f272e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11940ed50>]}
[0m14:40:03.489630 [info ] [MainThread]: Found 1 model, 596 macros
[0m14:40:03.489763 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '707b9f77-30c3-439d-bb24-3c2ca32f272e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x119486f90>]}
[0m14:40:03.490589 [info ] [MainThread]: 
[0m14:40:03.490728 [info ] [MainThread]: Concurrency: 4 threads (target='prod')
[0m14:40:03.490840 [info ] [MainThread]: 
[0m14:40:03.491032 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m14:40:03.491366 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG'
[0m14:40:03.521212 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG"
[0m14:40:03.521400 [debug] [ThreadPool]: On list_FD_IO_DLK_RG: show terse schemas in database FD_IO_DLK_RG
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG"} */
[0m14:40:03.521509 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:40:06.559646 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.038 seconds
[0m14:40:06.564081 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG, now list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION)
[0m14:40:06.579629 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m14:40:06.580082 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */;
[0m14:40:07.095747 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 0.515 seconds
[0m14:40:07.102619 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '707b9f77-30c3-439d-bb24-3c2ca32f272e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d53e9c0>]}
[0m14:40:07.107813 [debug] [Thread-1 (]: Began running node model.dbt_rg_snowflake.test
[0m14:40:07.108693 [info ] [Thread-1 (]: 1 of 1 START sql table model DLK_RG_BDA_ACQUISITION.test ....................... [RUN]
[0m14:40:07.109336 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m14:40:07.109748 [debug] [Thread-1 (]: Began compiling node model.dbt_rg_snowflake.test
[0m14:40:07.117142 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m14:40:07.118712 [debug] [Thread-1 (]: Began executing node model.dbt_rg_snowflake.test
[0m14:40:07.141092 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_rg_snowflake.test"
[0m14:40:07.149439 [debug] [Thread-1 (]: Using snowflake connection "model.dbt_rg_snowflake.test"
[0m14:40:07.150118 [debug] [Thread-1 (]: On model.dbt_rg_snowflake.test: create or replace transient table FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.test
    
    
    
    as (--CREATE OR REPLACE TABLE FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.agg_ticket_rg AS (

WITH first_ticket as (
    SELECT master_customer_id,
           min(purchase_date) as date_first_ticket
    from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg
    group by master_customer_id
)

SELECT a.master_customer_id, 
       
       min(purchase_date) as date_first_purchase,
       max(purchase_date) as date_last_purchase,
       AVG(DATEDIFF(DAY, lag_date_purchase, purchase_date)) as avg_delta_jour,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_web end ) AS amount_including_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then amount_including_taxes_mag end ) AS amount_including_taxes_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_day end ) AS amount_including_taxes_12m, 
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_ticket_web end ) AS nb_ticket_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket_mag end ) AS nb_ticket_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket end ) AS nb_ticket_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_achat_actif end ) AS nb_achat_actif_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  margin_excluding_taxes end ) as margin_excluding_taxes_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_web end ) as margin_excluding_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_mag end ) as margin_excluding_taxes_mag_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_web end ) AS nb_product_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_mag end ) AS nb_product_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte end ) AS nb_product_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_art end ) as nb_art_12m,
       sum(abs(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_retour end )) as nb_retour_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_markdown_including_taxes end ) as customer_markdown_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_discount_including_taxes end ) as customer_discount_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then initial_selling_price end ) as initial_selling_price_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  Total_Discount end )  as Total_Discount_12M,

       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_0_6m, 
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte else 0 end) AS nb_product_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_art else 0 end) as nb_art_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_0_6m,

       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_6_12m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte else 0 end) AS nb_product_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_art else 0 end) as nb_art_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_6_12m,
       
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_12m_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_12_18m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte else 0 end) AS nb_product_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_art else 0 end) as nb_art_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_12_18m,    

       SUM(case when(purchase_date = date_first_ticket) then amount_including_taxes_day else 0 end) AS amount_including_taxes_first_ticket, 
       SUM(case when(purchase_date = date_first_ticket) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_first_ticket,
       SUM(case when(purchase_date = date_first_ticket) then qte else 0 end) AS nb_product_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then nb_art else 0 end) as nb_art_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then initial_selling_price else 0 end) as initial_selling_price_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then Total_Discount else 0 end) as Total_Discount_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then amount_ventes else 0 end) as amount_ventes_first_ticket
      
from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg a
left join first_ticket b
on a.master_customer_id = b.master_customer_id

where purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)
and purchase_date >= b.date_first_ticket
group by a.master_customer_id

--)
    )

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "node_id": "model.dbt_rg_snowflake.test"} */;
[0m14:40:11.513109 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.362 seconds
[0m14:40:11.543335 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '707b9f77-30c3-439d-bb24-3c2ca32f272e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d3f7350>]}
[0m14:40:11.543918 [info ] [Thread-1 (]: 1 of 1 OK created sql table model DLK_RG_BDA_ACQUISITION.test .................. [[32mSUCCESS 1[0m in 4.43s]
[0m14:40:11.544338 [debug] [Thread-1 (]: Finished running node model.dbt_rg_snowflake.test
[0m14:40:11.545256 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:40:11.545506 [debug] [MainThread]: Connection 'model.dbt_rg_snowflake.test' was left open.
[0m14:40:11.545707 [debug] [MainThread]: On model.dbt_rg_snowflake.test: Close
[0m14:40:11.732246 [info ] [MainThread]: 
[0m14:40:11.733191 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 8.24 seconds (8.24s).
[0m14:40:11.734284 [debug] [MainThread]: Command end result
[0m14:40:11.762498 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:40:11.764281 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:40:11.768947 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/run_results.json
[0m14:40:11.769151 [info ] [MainThread]: 
[0m14:40:11.769394 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:40:11.769568 [info ] [MainThread]: 
[0m14:40:11.769774 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m14:40:11.773029 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 9.105378, "process_in_blocks": "0", "process_kernel_time": 0.283275, "process_mem_max_rss": "226721792", "process_out_blocks": "0", "process_user_time": 1.308899}
[0m14:40:11.773349 [debug] [MainThread]: Command `dbt run` succeeded at 14:40:11.773292 after 9.11 seconds
[0m14:40:11.773579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d956570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d5f2350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d5f3bb0>]}
[0m14:40:11.773787 [debug] [MainThread]: Flushing usage events
[0m14:40:12.482152 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:40:39.760088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107bc7a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1090ef890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1090efb10>]}


============================== 14:40:39.762794 | b57b58dd-d167-4867-91ac-9de828e6d864 ==============================
[0m14:40:39.762794 [info ] [MainThread]: Running with dbt=1.10.11
[0m14:40:39.763064 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'version_check': 'True', 'no_print': 'None', 'printer_width': '80', 'write_json': 'True', 'introspect': 'True', 'warn_error': 'None', 'indirect_selection': 'eager', 'log_format': 'default', 'profiles_dir': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'log_cache_events': 'False', 'empty': 'False', 'use_colors': 'True', 'target_path': 'None', 'log_path': '/Users/alexis.gray.ext/Projects/dbt-rg-snowflake/logs', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'debug': 'False', 'cache_selected_only': 'False', 'invocation_command': 'dbt run --select tag:daily', 'quiet': 'False', 'static_parser': 'True'}
[0m14:40:40.380650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b57b58dd-d167-4867-91ac-9de828e6d864', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083fb5c0>]}
[0m14:40:40.402821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b57b58dd-d167-4867-91ac-9de828e6d864', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f5186b0>]}
[0m14:40:40.403271 [info ] [MainThread]: Registered adapter: snowflake=1.10.1
[0m14:40:40.460087 [debug] [MainThread]: checksum: 5335e1629744fab92fa7809c625edbb36f0d7063a879d6215c971798f27e66f9, vars: {}, profile: , target: , version: 1.10.11
[0m14:40:40.521029 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:40:40.521213 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:40:40.531386 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b57b58dd-d167-4867-91ac-9de828e6d864', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f4c9c50>]}
[0m14:40:40.555581 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:40:40.558668 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:40:40.568711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b57b58dd-d167-4867-91ac-9de828e6d864', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f48ed50>]}
[0m14:40:40.568894 [info ] [MainThread]: Found 1 model, 596 macros
[0m14:40:40.569028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b57b58dd-d167-4867-91ac-9de828e6d864', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f50af90>]}
[0m14:40:40.569883 [info ] [MainThread]: 
[0m14:40:40.570018 [info ] [MainThread]: Concurrency: 4 threads (target='prod')
[0m14:40:40.570123 [info ] [MainThread]: 
[0m14:40:40.570316 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m14:40:40.570658 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG'
[0m14:40:40.598675 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG"
[0m14:40:40.598884 [debug] [ThreadPool]: On list_FD_IO_DLK_RG: show terse schemas in database FD_IO_DLK_RG
    limit 10000
/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG"} */
[0m14:40:40.598999 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:40:43.558268 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 2.959 seconds
[0m14:40:43.559488 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG, now list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION)
[0m14:40:43.565334 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m14:40:43.565517 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION
    limit 10000
    

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */;
[0m14:40:43.755925 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 0.190 seconds
[0m14:40:43.758759 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b57b58dd-d167-4867-91ac-9de828e6d864', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112d329c0>]}
[0m14:40:43.761189 [debug] [Thread-1 (]: Began running node model.dbt_rg_snowflake.test
[0m14:40:43.761530 [info ] [Thread-1 (]: 1 of 1 START sql table model DLK_RG_BDA_ACQUISITION.test ....................... [RUN]
[0m14:40:43.761792 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m14:40:43.761986 [debug] [Thread-1 (]: Began compiling node model.dbt_rg_snowflake.test
[0m14:40:43.766194 [debug] [Thread-1 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m14:40:43.766955 [debug] [Thread-1 (]: Began executing node model.dbt_rg_snowflake.test
[0m14:40:43.784265 [debug] [Thread-1 (]: Writing runtime sql for node "model.dbt_rg_snowflake.test"
[0m14:40:43.791335 [debug] [Thread-1 (]: Using snowflake connection "model.dbt_rg_snowflake.test"
[0m14:40:43.791976 [debug] [Thread-1 (]: On model.dbt_rg_snowflake.test: create or replace transient table FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.test
    
    
    
    as (--CREATE OR REPLACE TABLE FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.agg_ticket_rg AS (

WITH first_ticket as (
    SELECT master_customer_id,
           min(purchase_date) as date_first_ticket
    from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg
    group by master_customer_id
)

SELECT a.master_customer_id, 
       
       min(purchase_date) as date_first_purchase,
       max(purchase_date) as date_last_purchase,
       AVG(DATEDIFF(DAY, lag_date_purchase, purchase_date)) as avg_delta_jour,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_web end ) AS amount_including_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then amount_including_taxes_mag end ) AS amount_including_taxes_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_day end ) AS amount_including_taxes_12m, 
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_ticket_web end ) AS nb_ticket_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket_mag end ) AS nb_ticket_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket end ) AS nb_ticket_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_achat_actif end ) AS nb_achat_actif_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  margin_excluding_taxes end ) as margin_excluding_taxes_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_web end ) as margin_excluding_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_mag end ) as margin_excluding_taxes_mag_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_web end ) AS nb_product_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_mag end ) AS nb_product_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte end ) AS nb_product_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_art end ) as nb_art_12m,
       sum(abs(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_retour end )) as nb_retour_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_markdown_including_taxes end ) as customer_markdown_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_discount_including_taxes end ) as customer_discount_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then initial_selling_price end ) as initial_selling_price_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  Total_Discount end )  as Total_Discount_12M,

       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_0_6m, 
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte else 0 end) AS nb_product_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_art else 0 end) as nb_art_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_0_6m,

       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_6_12m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte else 0 end) AS nb_product_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_art else 0 end) as nb_art_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_6_12m,
       
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_12m_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_12_18m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte else 0 end) AS nb_product_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_art else 0 end) as nb_art_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_12_18m,    

       SUM(case when(purchase_date = date_first_ticket) then amount_including_taxes_day else 0 end) AS amount_including_taxes_first_ticket, 
       SUM(case when(purchase_date = date_first_ticket) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_first_ticket,
       SUM(case when(purchase_date = date_first_ticket) then qte else 0 end) AS nb_product_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then nb_art else 0 end) as nb_art_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then initial_selling_price else 0 end) as initial_selling_price_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then Total_Discount else 0 end) as Total_Discount_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then amount_ventes else 0 end) as amount_ventes_first_ticket
      
from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg a
left join first_ticket b
on a.master_customer_id = b.master_customer_id

where purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)
and purchase_date >= b.date_first_ticket
group by a.master_customer_id

--)
    )

/* {"app": "dbt", "dbt_version": "1.10.11", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "node_id": "model.dbt_rg_snowflake.test"} */;
[0m14:40:47.585320 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.792 seconds
[0m14:40:47.621241 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b57b58dd-d167-4867-91ac-9de828e6d864', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ceb350>]}
[0m14:40:47.621858 [info ] [Thread-1 (]: 1 of 1 OK created sql table model DLK_RG_BDA_ACQUISITION.test .................. [[32mSUCCESS 1[0m in 3.86s]
[0m14:40:47.622274 [debug] [Thread-1 (]: Finished running node model.dbt_rg_snowflake.test
[0m14:40:47.623218 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:40:47.623465 [debug] [MainThread]: Connection 'model.dbt_rg_snowflake.test' was left open.
[0m14:40:47.623658 [debug] [MainThread]: On model.dbt_rg_snowflake.test: Close
[0m14:40:47.793953 [info ] [MainThread]: 
[0m14:40:47.794676 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 7.22 seconds (7.22s).
[0m14:40:47.795619 [debug] [MainThread]: Command end result
[0m14:40:47.821253 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/manifest.json
[0m14:40:47.822468 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/semantic_manifest.json
[0m14:40:47.826787 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/alexis.gray.ext/Projects/dbt-rg-snowflake/target/run_results.json
[0m14:40:47.827009 [info ] [MainThread]: 
[0m14:40:47.827237 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:40:47.827402 [info ] [MainThread]: 
[0m14:40:47.827584 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m14:40:47.830560 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 8.10528, "process_in_blocks": "0", "process_kernel_time": 0.255345, "process_mem_max_rss": "224231424", "process_out_blocks": "0", "process_user_time": 1.277144}
[0m14:40:47.830817 [debug] [MainThread]: Command `dbt run` succeeded at 14:40:47.830768 after 8.11 seconds
[0m14:40:47.831017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112e4a570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112de2350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112de3bb0>]}
[0m14:40:47.831220 [debug] [MainThread]: Flushing usage events
[0m14:40:48.373000 [debug] [MainThread]: An error was encountered while trying to flush usage events


============================== 08:03:30.846073 | 459d20c9-75fb-4ff3-98d0-782e28969502 ==============================
[0m08:03:30.846073 [info ] [Dummy-1   ]: Running with dbt=1.9.4
[0m08:03:30.847531 [debug] [Dummy-1   ]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/tmp/dbt/', 'debug': 'False', 'version_check': 'True', 'log_path': '/tmp/dbt/logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt ', 'target_path': '/tmp/dbt/target/', 'log_format': 'default', 'send_anonymous_usage_stats': 'False'}
[0m08:03:31.214283 [info ] [Dummy-1   ]: Registered adapter: snowflake=1.9.2
[0m08:03:32.570089 [debug] [Dummy-1   ]: checksum: 6d8301ed5f8f0471e249cbcc8805b42bc5f78a9b258cb4e5c4b012c6ace116b4, vars: {}, profile: , target: prod, version: 1.9.4
[0m08:03:32.572883 [info ] [Dummy-1   ]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m08:03:34.497932 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m08:03:34.501637 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m08:03:34.555267 [info ] [Dummy-1   ]: Found 1 model, 591 macros
[0m08:03:34.558281 [info ] [Dummy-1   ]: 
[0m08:03:34.559392 [info ] [Dummy-1   ]: Concurrency: 4 threads (target='prod')
[0m08:03:34.560363 [info ] [Dummy-1   ]: 
[0m08:03:34.561798 [debug] [Dummy-1   ]: Acquiring new snowflake connection 'master'
[0m08:03:34.564977 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION'
[0m08:03:34.796160 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m08:03:34.797165 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session set quoted_identifiers_ignore_case = false;
[0m08:03:34.798046 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:03:35.323012 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.525 seconds
[0m08:03:35.328612 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m08:03:35.329511 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION
    limit 10000
    
;
[0m08:03:35.461876 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 0.131 seconds
[0m08:03:35.590456 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m08:03:35.591452 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session unset quoted_identifiers_ignore_case;
[0m08:03:35.648154 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.056 seconds
[0m08:03:35.668355 [debug] [Thread-2 (]: Began running node model.dbt_rg_snowflake.test
[0m08:03:35.669561 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m08:03:35.670581 [debug] [Thread-2 (]: Began compiling node model.dbt_rg_snowflake.test
[0m08:03:35.680599 [debug] [Thread-2 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m08:03:35.682427 [debug] [Thread-2 (]: Began executing node model.dbt_rg_snowflake.test
[0m08:03:35.683773 [debug] [Thread-2 (]: Finished running node model.dbt_rg_snowflake.test
[0m08:03:35.688471 [debug] [Dummy-1   ]: Connection 'master' was properly closed.
[0m08:03:35.689322 [debug] [Dummy-1   ]: Connection 'model.dbt_rg_snowflake.test' was properly closed.
[0m08:03:35.690584 [debug] [Dummy-1   ]: Command end result
[0m08:03:35.726416 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m08:03:35.729909 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m08:03:35.738713 [debug] [Dummy-1   ]: Wrote artifact RunExecutionResult to /tmp/dbt/target/run_results.json
[0m08:03:35.741826 [debug] [Dummy-1   ]: Resource report: {"command_name": "compile", "command_success": true, "command_wall_clock_time": 4.985241, "process_in_blocks": "0", "process_kernel_time": 1.09, "process_mem_max_rss": "503156", "process_out_blocks": "0", "process_user_time": 8.8}
[0m08:03:35.742782 [debug] [Dummy-1   ]: Command `cli compile` succeeded at 08:03:35.742444 after 4.99 seconds
[0m08:03:35.743603 [debug] [Dummy-1   ]: Flushing usage events


============================== 01:48:56.149480 | 74682dc3-a48f-40d6-bd0e-b463fc96e50d ==============================
[0m01:48:56.149480 [info ] [Dummy-1   ]: Running with dbt=1.9.4
[0m01:48:56.151213 [debug] [Dummy-1   ]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/tmp/dbt/logs', 'profiles_dir': '/tmp/dbt/', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt ', 'introspect': 'True', 'target_path': '/tmp/dbt/target/', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'False'}
[0m01:48:56.542092 [info ] [Dummy-1   ]: Registered adapter: snowflake=1.9.2
[0m01:48:58.135714 [debug] [Dummy-1   ]: checksum: 6d8301ed5f8f0471e249cbcc8805b42bc5f78a9b258cb4e5c4b012c6ace116b4, vars: {}, profile: , target: prod, version: 1.9.4
[0m01:48:58.466357 [debug] [Dummy-1   ]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m01:48:58.467319 [debug] [Dummy-1   ]: Partial parsing enabled, no changes found, skipping parsing
[0m01:48:58.707923 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m01:48:58.711819 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m01:48:58.769459 [info ] [Dummy-1   ]: Found 1 model, 591 macros
[0m01:48:58.772574 [info ] [Dummy-1   ]: 
[0m01:48:58.773720 [info ] [Dummy-1   ]: Concurrency: 4 threads (target='prod')
[0m01:48:58.774677 [info ] [Dummy-1   ]: 
[0m01:48:58.776243 [debug] [Dummy-1   ]: Acquiring new snowflake connection 'master'
[0m01:48:58.779570 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION'
[0m01:48:59.034477 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m01:48:59.035604 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session set quoted_identifiers_ignore_case = false;
[0m01:48:59.036541 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:48:59.587958 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.551 seconds
[0m01:48:59.594397 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m01:48:59.595493 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION
    limit 10000
    
;
[0m01:48:59.715554 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 0.119 seconds
[0m01:48:59.718932 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m01:48:59.720091 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session unset quoted_identifiers_ignore_case;
[0m01:48:59.830894 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.110 seconds
[0m01:48:59.857125 [debug] [Thread-2 (]: Began running node model.dbt_rg_snowflake.test
[0m01:48:59.858524 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m01:48:59.859726 [debug] [Thread-2 (]: Began compiling node model.dbt_rg_snowflake.test
[0m01:48:59.870775 [debug] [Thread-2 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m01:48:59.872575 [debug] [Thread-2 (]: Began executing node model.dbt_rg_snowflake.test
[0m01:48:59.874074 [debug] [Thread-2 (]: Finished running node model.dbt_rg_snowflake.test
[0m01:48:59.879420 [debug] [Dummy-1   ]: Connection 'master' was properly closed.
[0m01:48:59.880532 [debug] [Dummy-1   ]: Connection 'model.dbt_rg_snowflake.test' was properly closed.
[0m01:48:59.881913 [debug] [Dummy-1   ]: Command end result
[0m01:48:59.920547 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m01:48:59.924530 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m01:48:59.934251 [debug] [Dummy-1   ]: Wrote artifact RunExecutionResult to /tmp/dbt/target/run_results.json
[0m01:48:59.942613 [debug] [Dummy-1   ]: Resource report: {"command_name": "compile", "command_success": true, "command_wall_clock_time": 3.8925774, "process_in_blocks": "0", "process_kernel_time": 1.19, "process_mem_max_rss": "453604", "process_out_blocks": "0", "process_user_time": 8.27}
[0m01:48:59.943800 [debug] [Dummy-1   ]: Command `cli compile` succeeded at 01:48:59.943408 after 3.89 seconds
[0m01:48:59.944718 [debug] [Dummy-1   ]: Flushing usage events


============================== 01:58:26.786744 | 8aca45f0-c79b-4474-90e7-a31e1e7dd4eb ==============================
[0m01:58:26.786744 [info ] [Dummy-1   ]: Running with dbt=1.9.4
[0m01:58:26.788166 [debug] [Dummy-1   ]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/tmp/dbt/logs', 'debug': 'False', 'profiles_dir': '/tmp/dbt/', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': '/tmp/dbt/target/', 'invocation_command': 'dbt ', 'send_anonymous_usage_stats': 'False'}
[0m01:58:27.148749 [info ] [Dummy-1   ]: Registered adapter: snowflake=1.9.2
[0m01:58:28.556098 [debug] [Dummy-1   ]: checksum: 6d8301ed5f8f0471e249cbcc8805b42bc5f78a9b258cb4e5c4b012c6ace116b4, vars: {}, profile: , target: prod, version: 1.9.4
[0m01:58:28.869353 [debug] [Dummy-1   ]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m01:58:28.870198 [debug] [Dummy-1   ]: Partial parsing enabled, no changes found, skipping parsing
[0m01:58:29.077479 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m01:58:29.081218 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m01:58:29.135690 [info ] [Dummy-1   ]: Found 1 model, 591 macros
[0m01:58:29.138500 [info ] [Dummy-1   ]: 
[0m01:58:29.139536 [info ] [Dummy-1   ]: Concurrency: 4 threads (target='prod')
[0m01:58:29.140477 [info ] [Dummy-1   ]: 
[0m01:58:29.141928 [debug] [Dummy-1   ]: Acquiring new snowflake connection 'master'
[0m01:58:29.144700 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION'
[0m01:58:29.381960 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m01:58:29.382976 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session set quoted_identifiers_ignore_case = false;
[0m01:58:29.383783 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:58:30.182453 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.798 seconds
[0m01:58:30.188136 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m01:58:30.189131 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION
    limit 10000
    
;
[0m01:58:30.297438 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 0.107 seconds
[0m01:58:30.300405 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m01:58:30.301322 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session unset quoted_identifiers_ignore_case;
[0m01:58:30.360909 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.059 seconds
[0m01:58:30.382519 [debug] [Thread-2 (]: Began running node model.dbt_rg_snowflake.test
[0m01:58:30.383839 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m01:58:30.384800 [debug] [Thread-2 (]: Began compiling node model.dbt_rg_snowflake.test
[0m01:58:30.395005 [debug] [Thread-2 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m01:58:30.396623 [debug] [Thread-2 (]: Began executing node model.dbt_rg_snowflake.test
[0m01:58:30.397934 [debug] [Thread-2 (]: Finished running node model.dbt_rg_snowflake.test
[0m01:58:30.402712 [debug] [Dummy-1   ]: Connection 'master' was properly closed.
[0m01:58:30.403655 [debug] [Dummy-1   ]: Connection 'model.dbt_rg_snowflake.test' was properly closed.
[0m01:58:30.404820 [debug] [Dummy-1   ]: Command end result
[0m01:58:30.439428 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m01:58:30.442667 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m01:58:30.451245 [debug] [Dummy-1   ]: Wrote artifact RunExecutionResult to /tmp/dbt/target/run_results.json
[0m01:58:30.455041 [debug] [Dummy-1   ]: Resource report: {"command_name": "compile", "command_success": true, "command_wall_clock_time": 3.7595522, "process_in_blocks": "0", "process_kernel_time": 1.23, "process_mem_max_rss": "446216", "process_out_blocks": "0", "process_user_time": 7.35}
[0m01:58:30.456085 [debug] [Dummy-1   ]: Command `cli compile` succeeded at 01:58:30.455742 after 3.76 seconds
[0m01:58:30.456964 [debug] [Dummy-1   ]: Flushing usage events


============================== 04:32:03.966771 | 359a46be-c093-43ff-b021-82aa50979d2e ==============================
[0m04:32:03.966771 [info ] [Dummy-1   ]: Running with dbt=1.9.4
[0m04:32:03.968267 [debug] [Dummy-1   ]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/tmp/dbt/logs', 'profiles_dir': '/tmp/dbt/', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt ', 'target_path': '/tmp/dbt/target/', 'log_format': 'default', 'send_anonymous_usage_stats': 'False'}
[0m04:32:04.351943 [info ] [Dummy-1   ]: Registered adapter: snowflake=1.9.2
[0m04:32:05.875195 [debug] [Dummy-1   ]: checksum: 6d8301ed5f8f0471e249cbcc8805b42bc5f78a9b258cb4e5c4b012c6ace116b4, vars: {}, profile: , target: prod, version: 1.9.4
[0m04:32:06.204739 [debug] [Dummy-1   ]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:32:06.205621 [debug] [Dummy-1   ]: Partial parsing enabled, no changes found, skipping parsing
[0m04:32:06.441665 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m04:32:06.445657 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m04:32:06.502542 [info ] [Dummy-1   ]: Found 1 model, 591 macros
[0m04:32:06.505286 [info ] [Dummy-1   ]: 
[0m04:32:06.506310 [info ] [Dummy-1   ]: Concurrency: 4 threads (target='prod')
[0m04:32:06.507187 [info ] [Dummy-1   ]: 
[0m04:32:06.508574 [debug] [Dummy-1   ]: Acquiring new snowflake connection 'master'
[0m04:32:06.511544 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION'
[0m04:32:06.767297 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m04:32:06.768469 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session set quoted_identifiers_ignore_case = false;
[0m04:32:06.769415 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:32:07.350001 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.580 seconds
[0m04:32:07.356116 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m04:32:07.357209 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION
    limit 10000
    
;
[0m04:32:07.502602 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 0.144 seconds
[0m04:32:07.505999 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m04:32:07.507070 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session unset quoted_identifiers_ignore_case;
[0m04:32:07.592870 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.085 seconds
[0m04:32:07.617517 [debug] [Thread-2 (]: Began running node model.dbt_rg_snowflake.test
[0m04:32:07.619046 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m04:32:07.620211 [debug] [Thread-2 (]: Began compiling node model.dbt_rg_snowflake.test
[0m04:32:07.631658 [debug] [Thread-2 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m04:32:07.633330 [debug] [Thread-2 (]: Began executing node model.dbt_rg_snowflake.test
[0m04:32:07.634981 [debug] [Thread-2 (]: Finished running node model.dbt_rg_snowflake.test
[0m04:32:07.640534 [debug] [Dummy-1   ]: Connection 'master' was properly closed.
[0m04:32:07.641539 [debug] [Dummy-1   ]: Connection 'model.dbt_rg_snowflake.test' was properly closed.
[0m04:32:07.643011 [debug] [Dummy-1   ]: Command end result
[0m04:32:07.681327 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m04:32:07.684970 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m04:32:07.694368 [debug] [Dummy-1   ]: Wrote artifact RunExecutionResult to /tmp/dbt/target/run_results.json
[0m04:32:07.697965 [debug] [Dummy-1   ]: Resource report: {"command_name": "compile", "command_success": true, "command_wall_clock_time": 3.8211372, "process_in_blocks": "0", "process_kernel_time": 1.16, "process_mem_max_rss": "455920", "process_out_blocks": "0", "process_user_time": 7.9}
[0m04:32:07.699210 [debug] [Dummy-1   ]: Command `cli compile` succeeded at 04:32:07.698762 after 3.82 seconds
[0m04:32:07.700272 [debug] [Dummy-1   ]: Flushing usage events


============================== 05:44:41.425685 | f9dbae19-18bf-4123-9745-2cabbd0aaa69 ==============================
[0m05:44:41.425685 [info ] [Dummy-1   ]: Running with dbt=1.9.4
[0m05:44:41.427139 [debug] [Dummy-1   ]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/tmp/dbt/', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/tmp/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt ', 'target_path': '/tmp/dbt/target/', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'False'}
[0m05:44:41.792608 [info ] [Dummy-1   ]: Registered adapter: snowflake=1.9.2
[0m05:44:43.263900 [debug] [Dummy-1   ]: checksum: 6d8301ed5f8f0471e249cbcc8805b42bc5f78a9b258cb4e5c4b012c6ace116b4, vars: {}, profile: , target: prod, version: 1.9.4
[0m05:44:43.578741 [debug] [Dummy-1   ]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:44:43.579724 [debug] [Dummy-1   ]: Partial parsing enabled, no changes found, skipping parsing
[0m05:44:43.806631 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m05:44:43.810723 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m05:44:43.876149 [info ] [Dummy-1   ]: Found 1 model, 591 macros
[0m05:44:43.879015 [info ] [Dummy-1   ]: 
[0m05:44:43.880019 [info ] [Dummy-1   ]: Concurrency: 4 threads (target='prod')
[0m05:44:43.880888 [info ] [Dummy-1   ]: 
[0m05:44:43.882265 [debug] [Dummy-1   ]: Acquiring new snowflake connection 'master'
[0m05:44:43.885193 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG'
[0m05:44:44.118535 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG"
[0m05:44:44.119529 [debug] [ThreadPool]: On list_FD_IO_DLK_RG: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG"} */
show terse schemas in database FD_IO_DLK_RG
    limit 10000
[0m05:44:44.120334 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:44:44.636219 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.516 seconds
[0m05:44:44.641476 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION'
[0m05:44:44.658006 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m05:44:44.659070 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session set quoted_identifiers_ignore_case = false;
[0m05:44:44.659940 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:44:45.151401 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.491 seconds
[0m05:44:45.157113 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m05:44:45.158121 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION
    limit 10000
    
;
[0m05:44:45.308316 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 0.149 seconds
[0m05:44:45.311718 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m05:44:45.312609 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session unset quoted_identifiers_ignore_case;
[0m05:44:45.399129 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.085 seconds
[0m05:44:45.419914 [debug] [Thread-2 (]: Began running node model.dbt_rg_snowflake.test
[0m05:44:45.421180 [info ] [Thread-2 (]: 1 of 1 START sql table model DLK_RG_BDA_ACQUISITION.test ....................... [RUN]
[0m05:44:45.422376 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m05:44:45.423296 [debug] [Thread-2 (]: Began compiling node model.dbt_rg_snowflake.test
[0m05:44:45.433751 [debug] [Thread-2 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m05:44:45.435247 [debug] [Thread-2 (]: Began executing node model.dbt_rg_snowflake.test
[0m05:44:45.477999 [debug] [Thread-2 (]: Writing runtime sql for node "model.dbt_rg_snowflake.test"
[0m05:44:45.497610 [debug] [Thread-2 (]: Using snowflake connection "model.dbt_rg_snowflake.test"
[0m05:44:45.500386 [debug] [Thread-2 (]: On model.dbt_rg_snowflake.test: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "node_id": "model.dbt_rg_snowflake.test"} */
create or replace transient table FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.test
         as
        (--CREATE OR REPLACE TABLE FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.agg_ticket_rg AS (

WITH first_ticket as (
    SELECT master_customer_id,
           min(purchase_date) as date_first_ticket
    from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg
    group by master_customer_id
)

SELECT a.master_customer_id, 
       
       min(purchase_date) as date_first_purchase,
       max(purchase_date) as date_last_purchase,
       AVG(DATEDIFF(DAY, lag_date_purchase, purchase_date)) as avg_delta_jour,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_web end ) AS amount_including_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then amount_including_taxes_mag end ) AS amount_including_taxes_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  amount_including_taxes_day end ) AS amount_including_taxes_12m, 
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_ticket_web end ) AS nb_ticket_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket_mag end ) AS nb_ticket_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_ticket end ) AS nb_ticket_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  nb_achat_actif end ) AS nb_achat_actif_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  margin_excluding_taxes end ) as margin_excluding_taxes_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_web end ) as margin_excluding_taxes_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then margin_excluding_taxes_mag end ) as margin_excluding_taxes_mag_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_web end ) AS nb_product_web_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte_mag end ) AS nb_product_store_12m,
       SUM(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then qte end ) AS nb_product_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_art end ) as nb_art_12m,
       sum(abs(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then nb_retour end )) as nb_retour_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_markdown_including_taxes end ) as customer_markdown_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then customer_discount_including_taxes end ) as customer_discount_including_taxes_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then initial_selling_price end ) as initial_selling_price_12m,
       sum(case when purchase_date < DATEADD(MONTH, 12, b.date_first_ticket) then  Total_Discount end )  as Total_Discount_12M,

       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_0_6m, 
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_0_6m,
       SUM(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then qte else 0 end) AS nb_product_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then nb_art else 0 end) as nb_art_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_0_6m,
       sum(case when(purchase_date < DATEADD(MONTH, 6, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_0_6m,

       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_6_12m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_6_12m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then qte else 0 end) AS nb_product_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then nb_art else 0 end) as nb_art_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_6_12m,
       sum(case when(purchase_date >= DATEADD(MONTH, 6, b.date_first_ticket) and purchase_date < DATEADD(YEAR, 1, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_6_12m,
       
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_web else 0 end) AS amount_including_taxes_web_12m_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_mag else 0 end) AS amount_including_taxes_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then amount_including_taxes_day else 0 end) AS amount_including_taxes_12_18m, 
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_web else 0 end) AS nb_ticket_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket_mag else 0 end) AS nb_ticket_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_ticket else 0 end) AS nb_ticket_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_achat_actif else 0 end) AS nb_achat_actif_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_web else 0 end) as margin_excluding_taxes_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then margin_excluding_taxes_mag else 0 end) as margin_excluding_taxes_mag_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_web else 0 end) AS nb_product_web_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte_mag else 0 end) AS nb_product_store_12_18m,
       SUM(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then qte else 0 end) AS nb_product_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then nb_art else 0 end) as nb_art_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then abs(nb_retour) else 0 end) as nb_retour_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then initial_selling_price else 0 end) as initial_selling_price_12_18m,
       sum(case when(purchase_date >= DATEADD(MONTH, 12, b.date_first_ticket) and purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)) then Total_Discount else 0 end) as Total_Discount_12_18m,    

       SUM(case when(purchase_date = date_first_ticket) then amount_including_taxes_day else 0 end) AS amount_including_taxes_first_ticket, 
       SUM(case when(purchase_date = date_first_ticket) then margin_excluding_taxes else 0 end) as margin_excluding_taxes_first_ticket,
       SUM(case when(purchase_date = date_first_ticket) then qte else 0 end) AS nb_product_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then nb_art else 0 end) as nb_art_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_markdown_including_taxes else 0 end) as customer_markdown_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then customer_discount_including_taxes else 0 end) as customer_discount_including_taxes_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then initial_selling_price else 0 end) as initial_selling_price_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then Total_Discount else 0 end) as Total_Discount_first_ticket,
       sum(case when(purchase_date = date_first_ticket) then amount_ventes else 0 end) as amount_ventes_first_ticket
      
from FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION.tmp_agg_ticket_rg a
left join first_ticket b
on a.master_customer_id = b.master_customer_id

where purchase_date < DATEADD(MONTH, 18, b.date_first_ticket)
and purchase_date >= b.date_first_ticket
group by a.master_customer_id

--)
        );
[0m05:44:45.502303 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m05:44:52.803658 [debug] [Thread-2 (]: SQL status: SUCCESS 1 in 7.301 seconds
[0m05:44:52.838769 [info ] [Thread-2 (]: 1 of 1 OK created sql table model DLK_RG_BDA_ACQUISITION.test .................. [[32mSUCCESS 1[0m in 7.41s]
[0m05:44:52.840128 [debug] [Thread-2 (]: Finished running node model.dbt_rg_snowflake.test
[0m05:44:52.845264 [debug] [Dummy-1   ]: Connection 'master' was properly closed.
[0m05:44:52.846257 [debug] [Dummy-1   ]: Connection 'list_FD_IO_DLK_RG' was properly closed.
[0m05:44:52.847071 [debug] [Dummy-1   ]: Connection 'model.dbt_rg_snowflake.test' was properly closed.
[0m05:44:52.847858 [info ] [Dummy-1   ]: 
[0m05:44:52.848759 [info ] [Dummy-1   ]: Finished running 1 table model in 0 hours 0 minutes and 8.97 seconds (8.97s).
[0m05:44:52.850057 [debug] [Dummy-1   ]: Command end result
[0m05:44:52.885289 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m05:44:52.888607 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m05:44:52.896527 [debug] [Dummy-1   ]: Wrote artifact RunExecutionResult to /tmp/dbt/target/run_results.json
[0m05:44:52.897399 [info ] [Dummy-1   ]: 
[0m05:44:52.898480 [info ] [Dummy-1   ]: [32mCompleted successfully[0m
[0m05:44:52.899359 [info ] [Dummy-1   ]: 
[0m05:44:52.900238 [info ] [Dummy-1   ]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m05:44:52.903255 [debug] [Dummy-1   ]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 11.573424, "process_in_blocks": "0", "process_kernel_time": 1.38, "process_mem_max_rss": "439984", "process_out_blocks": "0", "process_user_time": 7.97}
[0m05:44:52.904298 [debug] [Dummy-1   ]: Command `cli run` succeeded at 05:44:52.903924 after 11.58 seconds
[0m05:44:52.905180 [debug] [Dummy-1   ]: Flushing usage events


============================== 05:45:26.755271 | dd8cc0fd-ce62-4e11-a567-06244b663c1e ==============================
[0m05:45:26.755271 [info ] [Dummy-1   ]: Running with dbt=1.9.4
[0m05:45:26.756760 [debug] [Dummy-1   ]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/tmp/dbt/logs', 'profiles_dir': '/tmp/dbt/', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt ', 'target_path': '/tmp/dbt/target/', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'False'}
[0m05:45:27.120243 [info ] [Dummy-1   ]: Registered adapter: snowflake=1.9.2
[0m05:45:28.534911 [debug] [Dummy-1   ]: checksum: 6d8301ed5f8f0471e249cbcc8805b42bc5f78a9b258cb4e5c4b012c6ace116b4, vars: {}, profile: , target: prod, version: 1.9.4
[0m05:45:28.849941 [debug] [Dummy-1   ]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:45:28.850992 [debug] [Dummy-1   ]: Partial parsing enabled, no changes found, skipping parsing
[0m05:45:29.075580 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m05:45:29.079118 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m05:45:29.133064 [info ] [Dummy-1   ]: Found 1 model, 591 macros
[0m05:45:29.135975 [info ] [Dummy-1   ]: 
[0m05:45:29.136874 [info ] [Dummy-1   ]: Concurrency: 4 threads (target='prod')
[0m05:45:29.137668 [info ] [Dummy-1   ]: 
[0m05:45:29.138940 [debug] [Dummy-1   ]: Acquiring new snowflake connection 'master'
[0m05:45:29.141556 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION'
[0m05:45:29.374277 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m05:45:29.375338 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session set quoted_identifiers_ignore_case = false;
[0m05:45:29.376182 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:45:30.709640 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.333 seconds
[0m05:45:30.715428 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m05:45:30.716380 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
show objects in FD_IO_DLK_RG.DLK_RG_BDA_ACQUISITION
    limit 10000
    
;
[0m05:45:30.836506 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 0.119 seconds
[0m05:45:30.839606 [debug] [ThreadPool]: Using snowflake connection "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"
[0m05:45:30.840501 [debug] [ThreadPool]: On list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "dbt_rg_snowflake", "target_name": "prod", "connection_name": "list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION"} */
alter session unset quoted_identifiers_ignore_case;
[0m05:45:31.026010 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.185 seconds
[0m05:45:31.047100 [debug] [Thread-2 (]: Began running node model.dbt_rg_snowflake.test
[0m05:45:31.048350 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_FD_IO_DLK_RG_DLK_RG_BDA_ACQUISITION, now model.dbt_rg_snowflake.test)
[0m05:45:31.049290 [debug] [Thread-2 (]: Began compiling node model.dbt_rg_snowflake.test
[0m05:45:31.059813 [debug] [Thread-2 (]: Writing injected SQL for node "model.dbt_rg_snowflake.test"
[0m05:45:31.061374 [debug] [Thread-2 (]: Began executing node model.dbt_rg_snowflake.test
[0m05:45:31.062740 [debug] [Thread-2 (]: Finished running node model.dbt_rg_snowflake.test
[0m05:45:31.067597 [debug] [Dummy-1   ]: Connection 'master' was properly closed.
[0m05:45:31.068497 [debug] [Dummy-1   ]: Connection 'model.dbt_rg_snowflake.test' was properly closed.
[0m05:45:31.069706 [debug] [Dummy-1   ]: Command end result
[0m05:45:31.106239 [debug] [Dummy-1   ]: Wrote artifact WritableManifest to /tmp/dbt/target/manifest.json
[0m05:45:31.109803 [debug] [Dummy-1   ]: Wrote artifact SemanticManifest to /tmp/dbt/target/semantic_manifest.json
[0m05:45:31.119061 [debug] [Dummy-1   ]: Wrote artifact RunExecutionResult to /tmp/dbt/target/run_results.json
[0m05:45:31.122284 [debug] [Dummy-1   ]: Resource report: {"command_name": "compile", "command_success": true, "command_wall_clock_time": 4.4554396, "process_in_blocks": "0", "process_kernel_time": 1.22, "process_mem_max_rss": "445048", "process_out_blocks": "0", "process_user_time": 7.09}
[0m05:45:31.123350 [debug] [Dummy-1   ]: Command `cli compile` succeeded at 05:45:31.122949 after 4.46 seconds
[0m05:45:31.124189 [debug] [Dummy-1   ]: Flushing usage events
